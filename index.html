<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BeerSpy Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    /* Ensure the map container has height so Leaflet can render */
    #map {
      height: 100vh;
      width: 100%;
    }

    /* Style for the view‚Äêselect dropdown */
    #view-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 0.5rem;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      font-family: sans-serif;
    }
    #view-container label {
      margin-right: 0.5rem;
    }
    #view-container select {
      font-size: 1rem;
    }

    /* Styling for the price tooltip on markers */
    .cheap-label {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 2px;
      padding: 2px 4px;
      font-size: 0.9rem;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="view-container">
    <label for="view-select">Show by:</label>
    <select id="view-select">
      <option value="min">Cheapest</option>
      <option value="avg">Average</option>
      <option value="max">Expensive</option>
    </select>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <!-- Supabase client -->
  <script type="module">
    // REPLACE THESE WITH YOUR ACTUAL SUPABASE DETAILS
    const SUPABASE_URL = "https://bvuuhxlsilmroyidaovp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dXVoeGxzaWxtcm95aWRhb3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MTYzMzgsImV4cCI6MjA1ODk5MjMzOH0.eCueNnzM6ezrpsRqaILPefnFTuRRvhr0g_cWIguqYzc";

    document.addEventListener("DOMContentLoaded", async () => {
      // Initialize map
      const map = L.map("map").setView([-37.8136, 144.9631], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      let markers = [];

      // Fetch data from Supabase
      async function getBeerData(viewType) {
        const { data, error } = await fetch(`${SUPABASE_URL}/rest/v1/beer_prices?select=*`, {
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        }).then(res => res.json());

        if (error) {
          console.error("Supabase error:", error);
          return [];
        }
        return data;
      }

      // Process data and show markers
      async function refreshMarkers(view = "min") {
        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        const beerData = await getBeerData(view);
        if (!beerData) return;

        // Group data by pub
        const pubs = {};
        beerData.forEach(item => {
          const key = `${item.pub_name}-${item.lat}-${item.lon}`;
          if (!pubs[key]) {
            pubs[key] = {
              name: item.pub_name,
              lat: item.lat,
              lon: item.lon,
              prices: []
            };
          }
          pubs[key].prices.push(item.price);
        });

        // Calculate price metrics
        Object.values(pubs).forEach(pub => {
          pub.min = Math.min(...pub.prices);
          pub.avg = pub.prices.reduce((a, b) => a + b, 0) / pub.prices.length;
          pub.max = Math.max(...pub.prices);
        });

        // Add markers to map
        Object.values(pubs).forEach(pub => {
          const price = pub[view];
          const marker = L.marker([pub.lat, pub.lon]).addTo(map);
          
          marker.bindTooltip(`$${price.toFixed(2)}`, {
            permanent: true,
            className: "cheap-label"
          });

          marker.on("click", () => {
            // Show pub details popup
            const content = `
              <div style="max-width: 300px">
                <h3>${pub.name}</h3>
                <p><b>Cheapest:</b> $${pub.min.toFixed(2)}</p>
                <p><b>Average:</b> $${pub.avg.toFixed(2)}</p>
                <p><b>Most Expensive:</b> $${pub.max.toFixed(2)}</p>
              </div>
            `;
            marker.bindPopup(content).openPopup();
          });

          markers.push(marker);
        });
      }

      // Initial load
      await refreshMarkers("min");

      // Dropdown change handler
      document.getElementById("view-select").addEventListener("change", (e) => {
        refreshMarkers(e.target.value);
      });
    });
  </script>
</body>
</html>