<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeerSpy Melbourne - Live Beer Prices Map</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/umd/supabase.min.js"></script>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3417/3417754.png" type="image/png">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="/_vercel/insights/script.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BeerSpy">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        /* ======== CSS Variables ======== */
        :root {
            --primary: #2c3e50;
            --primary-light: #3c5975;
            --secondary: #286e9c;
            --secondary-dark: #2980b9;
            --accent: #e6bc22;
            --accent-dark: #d7782f;
            --warning: #e74c3c;
            --success: #27ae60;
            --light-gray: #f5f7f9;
            --medium-gray: #ecf0f1;
            --text-dark: #2c3e50;
            --text-medium: #7f8c8d;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        /* ======== Base Styles ======== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', 'Helvetica', Arial, sans-serif;
            background: var(--light-gray);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* ======== Header ======== */
        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            box-shadow: var(--box-shadow);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo .beer-icon {
            font-size: 2.2rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo p {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        /* ======== Main Layout ======== */
        #main-container {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
            /* Mobile-first: stack vertically by default */
            display: flex;
            flex-direction: column;
        }
        
        #map-container {
            flex: 1;
            position: relative;
            height: 70vh;
            min-height: 400px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        #map {
            background: var(--light-gray);
                height: 100% !important;
                width: 100% !important;
            min-height: 400px;
        }
        
        /* ======== User Location Marker ======== */
        .user-location-marker {
            background: none;
            border: none;
        }

        .user-location-icon {
            font-size: 20px;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* ======== Controls Panel ======== */

        
        #map-controls {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-section {
            margin-bottom: 15px;
        }
        
        .control-section h3 {
            margin-bottom: 12px;
            color: var(--primary);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .size-filter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .size-btn {
            padding: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: var(--text-dark);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }
        
        .size-btn:hover, 
        .size-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        #add-pub-btn {
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #add-pub-btn:hover {
            background: var(--accent-dark);
        }
        
        /* ======== Statistics ======== */
        .stats-container {
            display: flex;
            gap: 15px;
            text-align: center;
            margin-top: 5px;
        }
        
        .stat-card {
            flex: 1;
            background: var(--light-gray);
            border-radius: 4px;
            padding: 10px;
        }
        
        .stat-card .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-medium);
        }
        
        /* ======== Search Bar ======== */
        .search-container {
            position: absolute;
            top: 18px;
            right: 18px;
            z-index: 1000;
            width: 300px;
        }

        .search-bar {
            display: flex;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .search-bar input {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            font-size: 1rem;
        }
        
        .search-btn {
            background: var(--secondary);
            color: white;
            border: none;
            width: 50px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .search-btn:hover {
            background: var(--secondary-dark);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-radius: 0 0 4px 4px;
            z-index: 1001;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-item:hover {
            background: #f1f5f9;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item .place-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2px;
        }

        .search-item .place-address {
            font-size: 0.9em;
            color: var(--text-medium);
        }

        .search-item .place-type {
            font-size: 0.8em;
            color: var(--secondary);
            margin-top: 2px;
            font-style: italic;
        }

        .existing-pub-indicator {
            background: #e8f5e8;
            border-left: 3px solid var(--success);
        }

        .new-location-indicator {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }
        
        /* ======== Map Markers ======== */
        .price-bubble {
            background: var(--accent);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            min-width: 45px;
        }

        .price-bubble.recent {
            background: var(--success);
        }

        .price-bubble.average {
            background: #3498db;
        }

        .price-bubble.old {
            background: var(--warning);
        }
        /* ======== Charts ======== */
        #charts-section {
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chart-wrapper {
            background: #ffffff;
            border: 1px solid #d0d0d0;
            border-radius: 0;
            padding: 25px;
            min-height: 320px;
            box-shadow: none;
            position: relative;
        }

        .chart-wrapper h4 {
            margin: 0 0 20px 0;
            font-size: 0.95rem;
            color: #000000;
            text-align: left;
            font-family: 'Arial', sans-serif;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chart-wrapper canvas {
            height: 250px !important;
        }

        .chart-empty {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-medium);
            font-style: italic;
            display: none;
        }
/* New Charts Container */
#charts-container {
    max-width: 1200px;
    margin: 20px auto;
    width: 100%;
    padding: 0 20px;
}

@media (min-width: 768px) {
    #main-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        grid-template-areas: "map controls";
        gap: 20px;
        align-items: start;
    }
    
    #map-container {
        grid-area: map;
        height: 65vh;
        min-height: 450px;
    }
    
    #map-controls {
        grid-area: controls;
        width: auto;
        margin: 0;
    }
    
    /* Charts container matches map width on desktop */
    #charts-container {
        padding: 0 20px;
    }
}

@media (max-width: 767px) {
    #main-container {
        display: flex;
        flex-direction: column;
        padding: 10px;
        gap: 20px;
    }

    #map-container {
        height: 60vh;
        min-height: 350px;
    }
    
    #map-controls {
        width: 100%;
        margin: 0;
    }
    
    /* Charts container on mobile */
    #charts-container {
        margin: 10px auto 20px auto;
        padding: 0 10px;
        overflow: hidden;
    }
    
    .charts-container {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .chart-wrapper {
        min-height: 280px; /* ✅ Increased from 250px */
        padding: 15px;
        overflow: hidden;
        max-width: 100%;
    }
    
    .chart-wrapper canvas {
        height: 220px !important; /* ✅ Increased from 180px */
        max-width: 100% !important;
    }
    
    .chart-empty {
        height: 220px; /* ✅ Match canvas height */
    }
}
.leaflet-popup-pane {
    z-index: 9999 !important;
}

.leaflet-popup {
    z-index: 9999 !important;
}

.leaflet-popup-content-wrapper {
    z-index: 9999 !important;
}

.leaflet-popup-tip {
    z-index: 9999 !important;
}

        /* PWA-specific improvements */
        @media (display-mode: standalone) {
        /* Hide browser-specific elements when app is installed */
        .search-container {
            top: 10px; /* Less space needed without browser bar */
        }
        }

        /* Touch-friendly buttons */
        @media (max-width: 767px) {
        .size-btn, .day-btn, .toggle-btn {
            min-height: 44px; /* Apple's recommended touch target */
            font-size: 0.9rem;
        }
        
        /* Improve popup sizing on mobile */
        .leaflet-popup-content {
            max-width: calc(100vw - 40px) !important;
        }
        }


        /* Pull-to-refresh indicator */
        body {
        overscroll-behavior-y: contain;
        }

        /* Happy hour styling - higher specificity to override age classes */
        .price-bubble.happy-hour,
        .price-bubble.recent.happy-hour,
        .price-bubble.average.happy-hour,
        .price-bubble.old.happy-hour {
            background: #ff69b4 !important;
            animation: pulse-pink 2s infinite;
        }

        @keyframes pulse-pink {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ======== Popups ======== */
        .pub-popup {
            min-width: 280px;
            max-width: 350px;
        }
        
        .pub-popup h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .pub-popup .address {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-bottom: 15px;
        }
        
        .beer-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size:0.9rem;
        }
        
        .beer-table th {
            text-align: left;
            padding: 6px 4px;
            background: var(--medium-gray);
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: var(--text-medium);
            font-size:0.8rem;
        }
        
        .beer-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #f0f0f0;
            font-size:0.85rem;
        }
        .beer-table th:nth-child(1),
        .beer-table td:nth-child(1) {
            width: 35%;  /* Category column */
        }

        .beer-table th:nth-child(2),
        .beer-table td:nth-child(2) {
            width: 20%;  /* Size column */
        }

        .beer-table th:nth-child(3),
        .beer-table td:nth-child(3) {
            width: 25%;  /* Price column */
        }

        .beer-table th:nth-child(4),
        .beer-table td:nth-child(4) {
            width: 20%;  /* Status column */
        }
        .beer-price {
            text-align: right;
            color: var(--warning);
            font-weight: 600;
        }

        .beer-price.happy-hour {
            background: #ff69b4;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
        }
        /* Happy hour schedule row styling */
        .beer-table tr[style*="background: #f8f9fa"] td {
            border-bottom: 1px solid #e9ecef;
            padding: 4px;
        }
        @media (max-width: 480px) {
            .pub-popup {
                min-width: 260px;
                max-width: 300px;
            }
            
            .beer-table {
                font-size: 0.8rem;
            }
            
            .beer-table th,
            .beer-table td {
                padding: 4px 2px;
                font-size: 0.75rem;
            }
        }
        
        .last-updated {
            font-size: 0.8rem;
            color: #95a5a6;
            margin-bottom: 15px;
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .add-beer-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .add-beer-btn:hover {
            background: var(--secondary-dark);
        }
        
        /* ======== Modals ======== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        
        .modal-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-group input:focus, 
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-cancel {
            background: white;
            border: 1px solid #ddd;
            color: var(--text-dark);
        }
        
        .btn-cancel:hover {
            background: #f5f5f5;
        }
        
        .btn-submit {
            background: var(--accent);
            color: white;
        }
        
        .btn-submit:hover {
            background: var(--accent-dark);
        }
        
        .error {
            color: var(--warning);
            font-weight: 600;
            background: #fdecea;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .address-search-container {
            position: relative;
            z-index: 1000;
        }

        .address-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .address-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .address-result-item:hover {
            background: #f8f9fa;
        }

        .address-result-item:last-child {
            border-bottom: none;
        }

        .address-result-item .place-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .address-result-item .place-address {
            font-size: 0.9em;
            color: var(--text-medium);
            margin-top: 2px;
        }
        
        /* ======== Footer ======== */
        footer {
            background: var(--primary);
            color: white;
            text-align: center;
            padding: 15px;
            margin-top: auto;
        }
        
        /* ======== Responsive Design ======== */

        .days-filter {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    margin-top: 8px;
}

.day-btn {
    padding: 8px 4px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    color: var(--text-dark);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    font-size: 0.85rem;
}

.day-btn:hover, 
.day-btn.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
}

/* Mobile optimization */
@media (max-width: 767px) {
    .days-filter {
        gap: 4px;
    }
    
    .day-btn {
        padding: 10px 2px;
        font-size: 0.8rem;
    }
}
.price-bubble.unavailable {
    background: #95a5a6 !important;
    color: white;
}

/* ======== Legend Styles ======== */
.legend-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
}

.legend-bubble {
    width: 20px;
    height: 20px;
    border-radius: 10px;
    font-size: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    flex-shrink: 0;
}

.legend-bubble.recent {
    background: var(--success);
}

.legend-bubble.average {
    background: #3498db;
}

.legend-bubble.old {
    background: var(--warning);
}

.legend-bubble.happy-hour {
    background: #ff69b4;
    animation: pulse-pink 2s infinite;
}

.legend-bubble.unavailable {
    background: #95a5a6;
}

/* Mobile legend styles */
@media (max-width: 767px) {
    .legend-container {
        gap: 6px;
    }

    .legend-item {
        font-size: 0.85rem;
    }

    .legend-bubble {
        width: 18px;
        height: 18px;
    }
}

.pub-list-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.pub-info h4 { font-size: 0.95rem; margin-bottom: 4px; }
.pub-info .distance { font-size: 0.8rem; color: #666; }
.pub-price { 
    font-size: 1.1rem; 
    font-weight: bold; 
    color: var(--primary);
}
.value-score {
    font-size: 0.75rem;
    color: var(--success);
}

.value-toggle {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

.toggle-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    color: var(--text-dark);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    font-size: 0.9rem;
}

.toggle-btn:hover, 
.toggle-btn.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
}

.pub-list {
    border-radius: 4px;
    border: 1px solid #eee;
    background: white;
    max-height: 300px;
    overflow-y: auto;
}

.pub-list-item:hover {
    background: #f8f9fa;
}

.pub-list-item:last-child {
    border-bottom: none;
}

/* Mobile optimization for the list */
@media (max-width: 767px) {
    .pub-list {
        max-height: 200px;
    }
    
    .pub-info h4 {
        font-size: 0.9rem;
    }
    
    .pub-price {
        font-size: 1rem;
    }
}

.price-input-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.happy-hour-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: normal;
    margin-bottom: 0;
    white-space: nowrap;
}

.happy-hour-checkbox input[type="checkbox"] {
    width: auto;
    margin: 0;
}

@media (max-width: 767px) {
    .price-input-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}

.search-results.loading {
        background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
        background-size: 400% 100%;
        animation: shimmer 1.5s ease-in-out infinite;
    }

    @keyframes shimmer {
        0% { background-position: 100% 0; }
        100% { background-position: -100% 0; }
    }

    /* Improved visual hierarchy */
    .search-item.existing-pub-indicator {
        border-left: 4px solid var(--success);
        background: linear-gradient(90deg, #e8f5e8 0%, #f9f9f9 10%);
    }

    .search-item.new-location-indicator {
        border-left: 4px solid #ffc107;
        background: linear-gradient(90deg, #fff3cd 0%, #f9f9f9 10%);
    }

    /* Better mobile performance */
    @media (max-width: 767px) {
        .search-container {
            width: calc(100vw - 40px);
            max-width: 300px;
        }
        
        .search-results {
            max-height: 200px; /* Reduced for mobile */
        }
    }

    /* Preload indicator */
    .search-status {
        font-size: 0.8rem;
        color: var(--text-medium);
        padding: 8px 15px;
        text-align: center;
        font-style: italic;
    }

    /* Enhanced search result visual feedback */
    .search-item:hover {
        transform: translateX(2px);
        transition: transform 0.2s ease;
    }

    .search-item.existing-pub-indicator:hover {
        background: linear-gradient(90deg, #d4edda 0%, #f1f3f4 10%);
    }

    .search-item.new-location-indicator:hover {
        background: linear-gradient(90deg, #fff3cd 0%, #f1f3f4 10%);
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <div class="beer-icon">🍺</div>
                <div>
                    <h1>BeerSpy</h1>
                    <p>Find and submit Melbourne's cheapest beer prices!</p>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Container -->
    <div id="main-container">
        <!-- Map Container -->
        <div id="map-container">
            <div id="map"></div>
            
            <!-- Search Bar -->
                    <div class="search-container">
                        <div class="search-bar">
                         <input type="text" id="pub-search" placeholder="Search places in Melbourne...">
                        <button class="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div class="search-results" id="search-results"></div>
            </div>
        </div>

        
        <!-- Map Controls Panel -->
        <div id="map-controls">
            <div class="control-section">
                <h3>Beer Size</h3>
                <div class="size-filter">
                    <button class="size-btn active" data-size="pint">Pint</button>
                    <button class="size-btn" data-size="schooner">Schooner</button>
                    <button class="size-btn" data-size="pot">Pot</button>
                    <button class="size-btn" data-size="bottle">Bottle</button>
                    <button class="size-btn" data-size="can">Can</button>
                    <button class="size-btn" data-size="jug">Jug</button>
                </div>
            </div>
            <!-- Add to controls panel -->
            <div class="control-section">
                <h3>Best Value Near You</h3>
                <div class="value-toggle">
                    <button class="toggle-btn active" data-mode="value">Best Value</button>
                    <button class="toggle-btn" data-mode="distance">Closest</button>
                </div>
                <div id="pub-list" class="pub-list">
                    <!-- Dynamic list goes here -->
                </div>
            </div>

            <div class="control-section">
                <h3>Price Bubble Legend</h3>
                <div class="legend-container">
                    <div class="legend-item">
                        <div class="legend-bubble recent"></div>
                        <span>Recent (≤7 days)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble average"></div>
                        <span>Average (≤30 days)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble old"></div>
                        <span>Old (>30 days)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble happy-hour"></div>
                        <span>Happy Hour Active</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-bubble unavailable"></div>
                        <span>No Current Prices</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Add a New Pub</h3>
                <button id="add-pub-btn">
                    <i class="fas fa-plus"></i> Enter Pub Details
                </button>
            </div>
            
            <div class="control-section stats-container">
                <div class="stat-card">
                    <div class="value" id="pubs-count">0</div>
                    <div class="label">Pubs</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="beers-count">0</div>
                    <div class="label">Beers Logged</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="avg-price">-</div>
                    <div class="label">Avg Price</div>
                </div>
            </div>
            <div class="control-section">
        <h3>Feature suggestions!</h3>
        <a href="https://forms.gle/w54KVtXtHYD6KjM29" target="_blank" id="suggest-feature-btn" 
        style="display: flex; align-items: center; justify-content: center; gap: 8px; 
                padding: 12px; background: var(--secondary); color: white; 
                text-decoration: none; border-radius: 6px; font-weight: 600; 
                transition: var(--transition);">
            <i class="fas fa-lightbulb"></i> Suggest a Feature
        </a>
    </div>
        
        </div>
    </div>
</div>

<div id="charts-container">
    <div id="charts-section">
        <div class="control-section">
            <h3>Price Analytics</h3>
            <div class="charts-container">
                <div class="chart-wrapper">
                    <h4>Average Price Over Time</h4>
                    <canvas id="price-trend-chart"></canvas>
                    <div id="price-trend-empty" class="chart-empty">Not enough data</div>
                </div>
                <div class="chart-wrapper">
                    <h4>Price Distribution</h4>
                    <canvas id="price-histogram-chart"></canvas>
                    <div id="price-histogram-empty" class="chart-empty">Not enough data</div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Add Pub Modal -->
    <div class="modal" id="add-pub-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Pub</h2>
                <button class="close-btn" id="close-add-pub">&times;</button>
            </div>
            <div class="modal-body">
                <div id="error-message" class="error"></div>
                
                <div class="form-group">
                    <label for="pub-name">Pub Name *</label>
                    <input type="text" id="pub-name" required placeholder="Enter pub name">
                </div>
                
                <div class="form-group">
                    <label for="pub-address">Address *</label>
                    <div class="address-search-container">
                        <input type="text" id="pub-address" required placeholder="Start typing an address...">
                        <div class="address-results" id="address-results"></div>
                    </div>
                </div>
                

                
                <h3>Add Initial Beer</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="beer-category">Beer Category *</label>
                        <select id="beer-category" required>
                            <option value="house">House/Cheapest</option>
                            <option value="local">Victorian/Australian Beers</option>
                            <option value="guinness">Guinness</option>
                            <option value="pale-ale">Pale Ales</option>
                            <option value="ipa">IPAs</option>
                            <option value="lager">Lagers</option>
                            <option value="dark">Stouts & Porters</option>
                            <option value="specialty">Wheat/Sour/Cider</option>
                            <option value="international">Internationals</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="beer-size">Size *</label>
                        <select id="beer-size" required>
                            <option value="pint">Pint (568ml)</option>
                            <option value="schooner">Schooner (425ml)</option>
                            <option value="pot">Pot (285ml)</option>
                            <option value="bottle">Bottle</option>
                            <option value="can">Can</option>
                            <option value="jug">Jug</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="beer-price">Price (AUD) *</label>
                        <div class="price-input-container">
                            <input type="number" id="beer-price" min="0" step="0.01" required placeholder="0.00" style="width: 120px;">
                            <label class="happy-hour-checkbox">
                                <input type="checkbox" id="is-happy-hour"> Happy Hour Price?
                            </label>
                        </div>

                </div>
                

                <div id="happy-hour-details" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="happy-hour-start">Start Time</label>
                            <select id="happy-hour-start">
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="23:00">11:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="happy-hour-end">End Time</label>
                            <select id="happy-hour-end">
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="23:00">11:00 PM</option>
                                <option value="00:00">12:00 AM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Days</label>
                        <div class="days-filter">
                            <button type="button" class="day-btn" data-day="monday">Mon</button>
                            <button type="button" class="day-btn" data-day="tuesday">Tue</button>
                            <button type="button" class="day-btn" data-day="wednesday">Wed</button>
                            <button type="button" class="day-btn" data-day="thursday">Thu</button>
                            <button type="button" class="day-btn" data-day="friday">Fri</button>
                            <button type="button" class="day-btn" data-day="saturday">Sat</button>
                            <button type="button" class="day-btn" data-day="sunday">Sun</button>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pub-lat">Latitude</label>
                        <input type="text" id="pub-lat" readonly>
                    </div>
                    <div class="form-group">
                        <label for="pub-lon">Longitude</label>
                        <input type="text" id="pub-lon" readonly>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="cancel-add-pub">Cancel</button>
                <button class="modal-btn btn-submit" id="submit-pub-btn">Add Pub</button>
            </div>
        </div>
    </div>

    <!-- Submit New Price Modal -->
    <div class="modal" id="submit-price-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit New Price</h2>
                <button class="close-btn" id="close-submit-price">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="beer-category-select">Beer Category *</label>
                    <select id="beer-category-select" required>
                        <option value="">-- Select a category --</option>
                        <option value="house">House/Cheapest</option>
                        <option value="local">Victorian/Australian Beers</option>
                        <option value="guinness">Guinness</option>
                        <option value="pale-ale">Pale Ales</option>
                        <option value="ipa">IPAs</option>
                        <option value="lager">Lagers</option>
                        <option value="dark">Stouts & Porters</option>
                        <option value="specialty">Wheat/Sour/Cider</option>
                        <option value="international">Internationals</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="beer-size-select">Size *</label>
                        <select id="beer-size-select" required>
                            <option value="pint">Pint</option>
                            <option value="schooner">Schooner</option>
                            <option value="pot">Pot</option>
                            <option value="bottle">Bottle</option>
                            <option value="can">Can</option>
                            <option value="jug">Jug</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="beer-price-input">Price (AUD) *</label>
                       <div class="price-input-container">
                            <input type="number" id="beer-price-input" min="0" step="0.01" required placeholder="0.00" style="width: 120px;">
                            <label class="happy-hour-checkbox">
                                <input type="checkbox" id="is-happy-hour-price"> Happy Hour Price?
                            </label>
                        </div>
                    </div>
                </div>
                


                <div id="happy-hour-price-details" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="happy-hour-price-start">Start Time</label>
                            <select id="happy-hour-price-start">
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="23:00">11:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="happy-hour-price-end">End Time</label>
                            <select id="happy-hour-price-end">
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="23:00">11:00 PM</option>
                                <option value="00:00">12:00 AM</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Days</label>
                        <div class="days-filter">
                            <button type="button" class="day-btn" data-day="monday">Mon</button>
                            <button type="button" class="day-btn" data-day="tuesday">Tue</button>
                            <button type="button" class="day-btn" data-day="wednesday">Wed</button>
                            <button type="button" class="day-btn" data-day="thursday">Thu</button>
                            <button type="button" class="day-btn" data-day="friday">Fri</button>
                            <button type="button" class="day-btn" data-day="saturday">Sat</button>
                            <button type="button" class="day-btn" data-day="sunday">Sun</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="cancel-submit-price">Cancel</button>
                <button class="modal-btn btn-submit" id="submit-price-btn">Submit Price</button>
            </div>
        </div>
    </div>
    <div class="modal" id="terms-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Terms & Privacy</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Terms of Use</h3>
                <p>• Submit accurate information only<br>
                • Prices are user contributed and may be outdated and inaccurate<br>
                • BeerSpy is not responsible for incorrect information</p>
                
                <h3>Privacy</h3>
                <p>• We use your device location to center the map only<br>
                • Location data is not stored or transmitted<br>
                • No personal information is collected or logged</p>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <p>BeerSpy alpha v0.2.20 &copy; 2025</p>
            <p style="font-size: 0.8rem; opacity: 0.8;">
        Drink Responsibly. Prices are user-submitted and may not be current or accurate. Location used for map display only. 
        <a href="#" onclick="showTerms()">Terms</a> | <a href="#" onclick="showPrivacy()">Privacy</a>
    </p>
    </footer>
    <script type="module">
        // =====================================
        // CONSTANTS & CONFIGURATION
        // =====================================
        const CONFIG = {
            SUPABASE_URL: "https://bvuuhxlsilmroyidaovp.supabase.co",
            SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dXVoeGxzaWxtcm95aWRhb3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MTYzMzgsImV4cCI6MjA1ODk5MjMzOH0.eCueNnzM6ezrpsRqaILPefnFTuRRvhr0g_cWIguqYzc",
            DEFAULT_LOCATION: { lat: -37.8136, lon: 144.9631 },
            SEARCH_DELAY: 150, // Reduced from 300ms
                GEOCODING_DELAY: 50, // Reduced from 100ms  
                TEST_MODE: false,
                // NEW: Search optimization settings
                SEARCH_CACHE_SIZE: 100,
                SEARCH_BATCH_SIZE: 3,
                PRELOAD_SEARCHES: true
        };

        const BEER_CATEGORIES = {
            'house': 'House/Cheapest',
            'local': 'Victorian/Australian Beers',
            'pale-ale': 'Pale Ales',
            'ipa': 'IPAs',
            'lager': 'Lagers',
            'dark': 'Stouts & Porters',
            'guinness': 'Guinness',
            'specialty': 'Wheat/Sour/Cider',
            'international': 'Internationals'
        };

        // =====================================
        // GLOBAL STATE
        // =====================================
        class AppState {
            constructor() {
                this.map = null;
                this.sbClient = null;
                this.userLocation = null;
                this.pubs = [];
                this.markers = [];
                this.currentSize = "pint";
                this.currentPubForPriceUpdate = null;
                this.searchTimeout = null;
            }

            init() {
                this.sbClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                console.log("BeerSpy app initialized");
            }
        }

        const appState = new AppState();

        // =====================================
        // UTILITY FUNCTIONS
        // =====================================
        const Utils = {
            showError(message, elementId = 'error-message') {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
                console.error(message);
            },
            // Add to Utils object
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km lol
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in km
            },

            calculatePubScore(pub, userLocation, currentSize) {
                const beers = pub.beers.filter(b => b.size === currentSize);
                if (!beers.length) return null;
                
                const cheapestPrice = Math.min(...beers.map(b => b.price));
                const distance = this.calculateDistance(
                    userLocation.lat, userLocation.lon, 
                    pub.lat, pub.lon
                );
                
                // Weighted score: prioritize price but penalize distance
                // Lower score = better value
                const distanceWeight = Math.max(0.1, distance * 0.5); // Min 0.1km penalty
                return cheapestPrice * distanceWeight;
            },

            hideError(elementId = 'error-message') {
                const errorElement = document.getElementById(elementId);
                if (errorElement) {
                    errorElement.style.display = 'none';
                    errorElement.textContent = '';
                }
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            formatPrice(price) {
                return `$${parseFloat(price).toFixed(2)}`;
            },

            formatDate(dateString) {
                if (!dateString) return new Date().toLocaleString();
                
                let timestamp = dateString;
                if (!timestamp.endsWith('Z') && !timestamp.includes('+')) {
                    timestamp += 'Z';
                }
                
                const date = new Date(timestamp);
                return date.toLocaleString(undefined, { 
                    hour12: false, 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
            },

            getDaysDifference(dateString) {
                if (!dateString) return 0;
                
                let timestamp = dateString;
                if (!timestamp.endsWith('Z') && !timestamp.includes('+')) {
                    timestamp += 'Z';
                }
                
                const now = new Date();
                const date = new Date(timestamp);
                return (now - date) / (1000 * 60 * 60 * 24);
            }
        };

        // =====================================
        // LOCATION SERVICES
        // =====================================
        const LocationService = {
            async getUserLocation() {
                // Try GPS first
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                timeout: 5000,
                                enableHighAccuracy: true
                            });
                        });
                        
                        return {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            source: 'gps'
                        };
                    } catch (gpsError) {
                        console.log("GPS failed, trying IP location:", gpsError.message);
                    }
                }

                // Fallback to IP-based location
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    if (data.latitude && data.longitude) {
                        const lat = parseFloat(data.latitude);
                        const lon = parseFloat(data.longitude);
                        
                        // Check if user is in Victoria area
                        if (lat >= -39.2 && lat <= -34.0 && lon >= 140.9 && lon <= 150.0) {
                            return {
                                lat: lat,
                                lon: lon,
                                source: 'ip',
                                city: data.city,
                                region: data.region
                            };
                        } else {
                            throw new Error(`Location outside Victoria: ${data.city}, ${data.region}`);
                        }
                    }
                } catch (ipError) {
                    console.log("IP location failed:", ipError.message);
                }

                throw new Error("No location services available");
            },

            async geocodeAddress(address) {
                await new Promise(resolve => setTimeout(resolve, CONFIG.GEOCODING_DELAY));
                
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);

                        if (!isNaN(lat) && !isNaN(lon)) {
                            return { lat, lon, result };
                        }
                    }
                    return null;
                } catch (error) {
                    console.error("Geocoding error:", error);
                    return null;
                }
            }
        };

        // =====================================
        // MAP MANAGEMENT
        // =====================================
        const MapManager = {
            async initialize() {
                let mapCenter = CONFIG.DEFAULT_LOCATION;
                let zoom = 13;

                try {
                    const location = await LocationService.getUserLocation();
                    if (location) {
                        appState.userLocation = location;
                        mapCenter = { lat: location.lat, lon: location.lon };
                        zoom = 14;
                        console.log("Using user location:", location);
                    }
                } catch (error) {
                    console.log("Using default Melbourne location:", error.message);
                }

                appState.map = L.map("map").setView([mapCenter.lat, mapCenter.lon], zoom);
                setTimeout(() => {
                    if (appState.map) {
                        appState.map.invalidateSize();
                    }
                }, 100);
                window.addEventListener('resize', () => {
                    if (appState.map) {
                        setTimeout(() => appState.map.invalidateSize(), 100);
                    }
                });

                window.addEventListener('orientationchange', () => {
                    if (appState.map) {
                        setTimeout(() => appState.map.invalidateSize(), 300);
                    }
                });

                L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors",
                }).addTo(appState.map);

                // Add user location marker if GPS was used
                if (appState.userLocation && appState.userLocation.source === 'gps') {
                    L.marker([appState.userLocation.lat, appState.userLocation.lon], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: '<div class="user-location-icon">📍</div>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(appState.map).bindPopup("Your location");
                }

                this.setupMapEvents();
            },

            setupMapEvents() {
    appState.map.on('click', (e) => {
        if (!e.originalEvent.target.closest('.leaflet-marker-icon')) {
            appState.map.closePopup();
        }
    });

    appState.map.on("popupopen", (e) => {
        // DON'T hide search container - just let search results hide naturally via click handlers
        
        setTimeout(() => {
            const popupContainer = e.popup.getElement();
            if (!popupContainer) return;
            
            const contentNode = popupContainer.querySelector(".leaflet-popup-content");
            if (!contentNode) return;
            
            const submitBtn = contentNode.querySelector(".add-beer-btn");
            if (submitBtn) {
                submitBtn.onclick = () => {
                    const popupLatLng = e.popup.getLatLng();
                    const pub = appState.pubs.find(p => 
                        Math.abs(p.lat - popupLatLng.lat) < 0.0001 && 
                        Math.abs(p.lon - popupLatLng.lng) < 0.0001
                    );
                    if (pub) {
                        appState.currentPubForPriceUpdate = pub;
                        ModalManager.openSubmitPriceModal(pub);
                    }
                };
            }
        }, 100);
    });

    appState.map.on("popupclose", (e) => {
        // DON'T restore search container visibility - let the search system handle its own state
    });
},
            createCustomIcon(price, ageClass, isCurrentlyHappyHour = false, showUnavailable = false) {
                const happyHourClass = isCurrentlyHappyHour ? ' happy-hour' : '';
                const unavailableClass = showUnavailable ? ' unavailable ' : '';
                const displayPrice = showUnavailable ? ' -- ' : Utils.formatPrice(price);
                
                return L.divIcon({
                    className: "custom-marker",
                    html: `<div class="price-bubble ${ageClass}${happyHourClass}${unavailableClass}">${displayPrice}</div>`,
                    iconSize: [60, 30],
                    iconAnchor: [30, 15],      // ✅ FIXED: Center horizontally, center vertically
                    popupAnchor: [0, -15]      // ✅ FIXED: Popup arrow points to center of bubble
                });
            },

            renderMarkers() {
                // Clear existing markers
                appState.markers.forEach((marker) => {
                    if (appState.map.hasLayer(marker)) {
                        appState.map.removeLayer(marker);
                    }
                });
                appState.markers = [];

                appState.pubs.forEach((pub) => {
                    const beersForSize = pub.beers.filter((beer) => beer.size === appState.currentSize);
                    if (beersForSize.length === 0) return;

                    // Separate beers into regular and happy hour, getting most recent for each beer name
                    const regularBeerMap = new Map();
                    const happyHourBeerMap = new Map();
                    
                    beersForSize.forEach(beer => {
                        const beerTime = beer.last_updated ? new Date(beer.last_updated) : new Date(0);
                        
                        if (beer.is_happy_hour) {
                            const existingHappyHour = happyHourBeerMap.get(beer.name);
                            if (!existingHappyHour || beerTime > existingHappyHour.time) {
                                happyHourBeerMap.set(beer.name, { beer, time: beerTime });
                            }
                        } else {
                            const existingRegular = regularBeerMap.get(beer.name);
                            if (!existingRegular || beerTime > existingRegular.time) {
                                regularBeerMap.set(beer.name, { beer, time: beerTime });
                            }
                        }
                    });

                    // Check if any happy hour beers are currently active
                    const activeHappyHourBeers = Array.from(happyHourBeerMap.values())
                        .filter(item => this.checkIfCurrentlyHappyHour(item.beer))
                        .map(item => item.beer);

                    let displayBeer, displayPrice, isCurrentlyHappyHour, showUnavailable = false;

                    if (activeHappyHourBeers.length > 0) {
                        // Use cheapest active happy hour price
                        displayBeer = activeHappyHourBeers.reduce((cheapest, beer) => 
                            beer.price < cheapest.price ? beer : cheapest
                        );
                        displayPrice = displayBeer.price;
                        isCurrentlyHappyHour = true;
                    } else {
                        // Use cheapest regular price
                        const regularBeers = Array.from(regularBeerMap.values()).map(item => item.beer);
                        if (regularBeers.length > 0) {
                            displayBeer = regularBeers.reduce((cheapest, beer) => 
                                beer.price < cheapest.price ? beer : cheapest
                            );
                            displayPrice = displayBeer.price;
                            isCurrentlyHappyHour = false;
                        } else {
                            // NO REGULAR PRICES AND NO ACTIVE HAPPY HOUR - Show "--"
                            showUnavailable = true;
                            displayPrice = "--";
                            isCurrentlyHappyHour = false;
                            
                            // Use any beer for age calculation (just for the marker age color)
                            const allBeers = Array.from(happyHourBeerMap.values()).map(item => item.beer);
                            if (allBeers.length === 0) return; // Skip this pub if no beers
                            displayBeer = allBeers[0]; // Just for age calculation
                        }
                    }
                    
                    // Determine age class based on the beer being displayed (or any beer if showing "--")
                    const ageInDays = Utils.getDaysDifference(displayBeer.last_updated);
                    let ageClass = ageInDays <= 7 ? 'recent' : ageInDays <= 30 ? 'average' : 'old';

                    const marker = L.marker([pub.lat, pub.lon], {
                        icon: this.createCustomIcon(displayPrice, ageClass, isCurrentlyHappyHour, showUnavailable),
                    }).addTo(appState.map);

                    marker.pubData = pub;
                    marker.on("click", this.onMarkerClick);
                    appState.markers.push(marker);
                });

                Statistics.update();
                if (typeof PubListManager !== 'undefined') {
                    PubListManager.updatePubList();
                }
                ChartsManager.updateCharts();
            },

            onMarkerClick(e) {
                const pub = e.target.pubData;
                const beersForSize = pub.beers.filter((beer) => beer.size === appState.currentSize);

                appState.map.closePopup();

                setTimeout(() => {
                    const popup = L.popup()
                        .setLatLng([pub.lat, pub.lon])
                        .setContent(MapManager.createPopupContent(pub, beersForSize))
                        .openOn(appState.map);
                }, 50);
            },

            createPopupContent(pub, beers) {
                let content = `
                    <div class="pub-popup">
                        <h3>${pub.name}</h3>
                        <div class="address">${pub.address}</div>
                        <table class="beer-table">
                            <tr>
                                <th>Category</th>
                                <th>Size</th>
                                <th>Price</th>
                                <th>Status</th>
                            </tr>
                `;

                // Group beers by category and size, separating regular and happy hour
                const beerGroups = new Map();
                
                beers.forEach(beer => {
                    const key = `${beer.name}_${beer.size}`;
                    if (!beerGroups.has(key)) {
                        beerGroups.set(key, {
                            category: beer.name,
                            size: beer.size,
                            regular: null,
                            happyHour: null
                        });
                    }
                    
                    const group = beerGroups.get(key);
                    const beerTime = beer.last_updated ? new Date(beer.last_updated) : new Date(0);
                    
                    if (beer.is_happy_hour) {
                        // Keep most recent happy hour price
                        if (!group.happyHour || beerTime > group.happyHour.time) {
                            group.happyHour = { beer, time: beerTime };
                        }
                    } else {
                        // Keep most recent regular price
                        if (!group.regular || beerTime > group.regular.time) {
                            group.regular = { beer, time: beerTime };
                        }
                    }
                });

                // Sort by price (regular price first, then happy hour price if no regular)
                const sortedGroups = Array.from(beerGroups.values()).sort((a, b) => {
                    const priceA = a.regular?.beer.price || a.happyHour?.beer.price || 999;
                    const priceB = b.regular?.beer.price || b.happyHour?.beer.price || 999;
                    return priceA - priceB;
                });

                sortedGroups.forEach((group) => {
                    const categoryName = BEER_CATEGORIES[group.category] || group.category;
                    
                    // Show regular price
                    if (group.regular) {
                        content += `
                            <tr>
                                <td>${categoryName}</td>
                                <td>${group.size}</td>
                                <td class="beer-price">${Utils.formatPrice(group.regular.beer.price)}</td>
                                <td><span style="color: #27ae60; font-size: 0.8em;">✓ Current</span></td>
                            </tr>
                        `;
                    }
                    
                    // Show happy hour price
                    if (group.happyHour) {
                        const isCurrentlyActive = this.checkIfCurrentlyHappyHour(group.happyHour.beer);
                        const statusClass = isCurrentlyActive ? 'color: #ff69b4; font-weight: bold;' : 'color: #95a5a6;';
                        const statusText = isCurrentlyActive ? '🎉 Happy Hour!' : 'Happy Hour (inactive)';
                        const priceClass = isCurrentlyActive ? ' happy-hour' : '';
                        
                        content += `
                            <tr>
                                <td>${categoryName}</td>
                                <td>${group.size}</td>
                                <td class="beer-price${priceClass}">${Utils.formatPrice(group.happyHour.beer.price)}</td>
                                <td><span style="${statusClass} font-size: 0.8em;">${statusText}</span></td>
                            </tr>
                        `;
                        
                        // Add happy hour schedule info
                        if (group.happyHour.beer.happy_hour_start && group.happyHour.beer.happy_hour_end && group.happyHour.beer.happy_hour_days) {
                            const days = Array.isArray(group.happyHour.beer.happy_hour_days) 
                                ? group.happyHour.beer.happy_hour_days.map(d => d.substring(0,3)).join(', ')
                                : 'Schedule TBC';
                            const timeRange = `${group.happyHour.beer.happy_hour_start}-${group.happyHour.beer.happy_hour_end}`;
                            
                            content += `
                                <tr style="background: #f8f9fa;">
                                    <td colspan="4" style="font-size: 0.75em; color: #666; font-style: italic;">
                                        Happy Hour: ${days}, ${timeRange}
                                    </td>
                                </tr>
                            `;
                        }
                    }
                    
                    // If only happy hour price exists, show it as the main price
                    if (!group.regular && group.happyHour) {
                        // Already handled above
                    }
                });

                const mostRecentUpdate = beers.reduce((latest, beer) => {
                    if (!beer.last_updated) return latest;
                    const beerDate = new Date(beer.last_updated + (beer.last_updated.endsWith('Z') ? '' : 'Z'));
                    return !latest || beerDate > latest ? beerDate : latest;
                }, null);

                const lastUpdatedDate = Utils.formatDate(mostRecentUpdate?.toISOString());

                content += `
                        </table>
                        <div class="last-updated">Updated: ${lastUpdatedDate}</div>
                        <div style="font-size: 0.75rem; color: #95a5a6; margin-bottom: 10px;">
                            💡 Prices are user-submitted and may not reflect current rates
                        </div>
                        <div class="popup-actions">
                            <button class="add-beer-btn">Submit New Price</button>
                        </div>
                    </div>
                `;
                return content;
            },

            checkIfCurrentlyHappyHour(beer) {
                if (!beer.is_happy_hour || !beer.happy_hour_start || !beer.happy_hour_end || !beer.happy_hour_days) {
                    return false;
                }
                
                const now = new Date();
                const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();      
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                // Check if today is a happy hour day
                if (!Array.isArray(beer.happy_hour_days) || !beer.happy_hour_days.includes(currentDay)) {
                    return false;
                }
                
                const [startHour, startMin] = beer.happy_hour_start.split(':').map(Number);
                const [endHour, endMin] = beer.happy_hour_end.split(':').map(Number);
                const startTime = startHour * 60 + startMin;
                const endTime = endHour * 60 + endMin;
                
                // Handle same-day happy hour
                if (startTime <= endTime) {
                    return currentTime >= startTime && currentTime <= endTime;
                } else {
                    // Handle happy hour that crosses midnight
                    return currentTime >= startTime || currentTime <= endTime;
                }
            }
        };

        // =====================================
        // DATA MANAGEMENT
        // =====================================
        const DataManager = {
            async fetchBeerPrices() {
                try {
                    if (CONFIG.TEST_MODE) {
                        appState.pubs = this.getTestData();
                        MapManager.renderMarkers();
                        console.log("Using local test data");
                        return;
                    }

                    const { data, error } = await appState.sbClient.from("beer_prices").select("*");

                    if (error) {
                        console.error("Error fetching beer prices from Supabase:", error.message);
                        MapManager.renderMarkers();
                        return;
                    }

                    if (!data || data.length === 0) {
                        console.warn("No data fetched from Supabase");
                        MapManager.renderMarkers();
                        return;
                    }

                    console.log("Fetched beer prices:", data);
                    this.processSupabaseData(data);
                    MapManager.renderMarkers();
                        if (typeof PubListManager !== 'undefined') {
                            PubListManager.updatePubList();
                        }
                } catch (err) {
                    console.error("Fetch from Supabase error:", err);
                    MapManager.renderMarkers();
                }
            },

            processSupabaseData(beerPrices) {
                const pubsMap = new Map();

                beerPrices.forEach((item) => {
                    const pubKey = `${item.pub_name}-${item.lat}-${item.lon}`;

                    if (!pubsMap.has(pubKey)) {
                        pubsMap.set(pubKey, {
                            id: pubsMap.size + 1,
                            name: item.pub_name,
                            address: item.location || "",
                            lat: item.lat,
                            lon: item.lon,
                            beers: [],
                        });
                    }

                    const pub = pubsMap.get(pubKey);
                    pub.beers.push({
                        name: item.beer_name,
                        size: item.size,
                        price: item.price,
                        last_updated: item.last_updated,
                        is_happy_hour: item.is_happy_hour || false,
                        happy_hour_start: item.happy_hour_start,
                        happy_hour_end: item.happy_hour_end,
                        happy_hour_days: item.happy_hour_days
                    });
                });

                appState.pubs = Array.from(pubsMap.values());
                console.log("Processed pubs:", appState.pubs);
            },
            async updateSingleBeerPrice(pubName, lat, lon, beerData) {
                try {
                    if (CONFIG.TEST_MODE) {
                        // Handle test mode
                        const pub = appState.pubs.find(p => p.name === pubName && p.lat === lat && p.lon === lon);
                        if (pub) {
                            const existingBeerIndex = pub.beers.findIndex(
                                beer => beer.name === beerData.name && beer.size === beerData.size
                            );
                            if (existingBeerIndex >= 0) {
                                pub.beers[existingBeerIndex] = { ...pub.beers[existingBeerIndex], ...beerData };
                            } else {
                                pub.beers.push(beerData);
                            }
                        }
                        MapManager.renderMarkers();
                        return;
                    }

                    // Insert new record (don't delete existing ones unless it's the exact same beer/size combo)
                    const newRecord = {
                        pub_name: pubName,
                        beer_name: beerData.name,
                        size: beerData.size,
                        price: beerData.price,
                        lat: lat,
                        lon: lon,
                        location: appState.currentPubForPriceUpdate.address,
                        last_updated: new Date().toISOString(),
                        is_happy_hour: beerData.is_happy_hour || false,
                        happy_hour_start: beerData.happy_hour_start || null,
                        happy_hour_end: beerData.happy_hour_end || null,
                        happy_hour_days: beerData.happy_hour_days || null
                    };

                    const { error: insertError } = await appState.sbClient
                        .from("beer_prices")
                        .insert([newRecord]);

                    if (insertError) {
                        throw new Error(`Error saving beer price: ${insertError.message}`);
                    }

                    await this.fetchBeerPrices();
                    Utils.hideError();
                } catch (err) {
                    console.error("Database update error:", err);
                    Utils.showError(`Database error: ${err.message}`);
                }
            },
            async updatePubInDatabase(pub) {
                console.log("Updating pub in database:", pub);

                try {
                    if (CONFIG.TEST_MODE) {
                        console.log("Not updating Supabase - test mode enabled");
                        appState.pubs = appState.pubs.map((p) => (p.id === pub.id ? pub : p));
                        MapManager.renderMarkers();
                        Utils.hideError();
                        return;
                    }

                    // Delete existing records for this pub
                    const { error: deleteError } = await appState.sbClient
                        .from("beer_prices")
                        .delete()
                        .eq("pub_name", pub.name)
                        .eq("lat", pub.lat)
                        .eq("lon", pub.lon);

                    if (deleteError) {
                        throw new Error(`Error deleting old records: ${deleteError.message}`);
                    }

                    // Insert new records
                    const newRecords = pub.beers.map((beer) => ({
                        pub_name: pub.name,
                        beer_name: beer.name,
                        size: beer.size,
                        price: beer.price,
                        lat: pub.lat,
                        lon: pub.lon,
                        location: pub.address,
                        last_updated: new Date().toISOString(),
                        is_happy_hour: beer.is_happy_hour || false,
                        happy_hour_start: beer.happy_hour_start || null,
                        happy_hour_end: beer.happy_hour_end || null,
                        happy_hour_days: beer.happy_hour_days || null
                    }));

                    const { error: insertError } = await appState.sbClient
                        .from("beer_prices")
                        .insert(newRecords);

                    if (insertError) {
                        throw new Error(`Error saving pub: ${insertError.message}`);
                    }

                    await this.fetchBeerPrices();
                    Utils.hideError();
                } catch (err) {
                    console.error("Database update error:", err);
                    Utils.showError(`Database error: ${err.message}`);
                }
            },

            getTestData() {
                return [
                    {
                        id: 1,
                        name: "The Lagerhaus",
                        address: "250 Collins St, Melbourne VIC 3000",
                        lat: -37.8140,
                        lon: 144.9643,
                        beers: [
                            { name: "house", size: "pint", price: 7.5 },
                            { name: "ipa", size: "pint", price: 9.0 },
                            { name: "local", size: "pint", price: 7.0 },
                        ],
                    },
                    {
                        id: 2,
                        name: "Hoppy Hop",
                        address: "45 Bourke St, Melbourne VIC 3000",
                        lat: -37.8240,
                        lon: 144.9843,
                        beers: [
                            { name: "ipa", size: "schooner", price: 5.5 },
                            { name: "dark", size: "pot", price: 6.5 },
                        ],
                    },
                ];
            }
        };

        // =====================================
        // SEARCH FUNCTIONALITY
        // =====================================
// =====================================
// OPTIMIZED SEARCH MANAGER
// =====================================
 // =====================================
// UNIFIED SEARCH SYSTEM
// =====================================
const SearchManager = {
    cache: new Map(),
    requestQueue: [],
    isProcessing: false,
    lastRequestTime: 0,
    MIN_REQUEST_INTERVAL: 1100,
    initialized: false, // Add flag to prevent duplicate initialization
    
    init() {
        if (this.initialized) return; // Prevent duplicate initialization
        this.initialized = true;
        
        this.initMainSearch();
        this.initAddPubSearch();
        this.preloadCommonSearches();
    },

    // ========== MAIN SEARCH BAR ==========
    initMainSearch() {
        const searchInput = document.getElementById("pub-search");
        const resultsDiv = document.getElementById("search-results");

        if (!searchInput || !resultsDiv) {
            console.error("Main search elements not found");
            return;
        }

        // Clear any existing listeners
        searchInput.removeEventListener("input", this.mainSearchHandler);
        
        // Create bound handler function
        this.mainSearchHandler = Utils.debounce((e) => {
            this.handleMainSearch(e.target.value.trim(), resultsDiv);
        }, 150);
        
        searchInput.addEventListener("input", this.mainSearchHandler);

        // Improved click outside handler - be more specific about what should close results
        this.mainClickOutsideHandler = (e) => {
            // Don't close if clicking on search input, results, or map markers
            if (searchInput.contains(e.target) || 
                resultsDiv.contains(e.target) ||
                e.target.closest('.leaflet-marker-icon') ||
                e.target.closest('.leaflet-popup') ||
                e.target.closest('.modal')) {
                return;
            }
            resultsDiv.classList.remove('show');
        };
        
        // Remove existing listener if it exists
        document.removeEventListener("click", this.mainClickOutsideHandler);
        document.addEventListener("click", this.mainClickOutsideHandler);

        // Handle search input focus to show results if they exist
        searchInput.addEventListener("focus", () => {
            if (resultsDiv.innerHTML.trim() && searchInput.value.trim().length >= 2) {
                resultsDiv.classList.add('show');
            }
        });
    },

    async handleMainSearch(query, resultsDiv) {
        if (query.length < 2) {
            resultsDiv.classList.remove('show');
            return;
        }

        try {
            // Search existing pubs first (instant)
            const existingResults = this.searchExistingPubs(query);

            // Search external locations (cached/queued)
            let geocodeResults = [];
            if (query.length >= 3) {
                geocodeResults = await this.searchExternal(query);
            }

            this.displayMainSearchResults(existingResults, geocodeResults, resultsDiv);
        } catch (error) {
            console.error("Main search error:", error);
            this.displayMainSearchResults([], [], resultsDiv);
        }
    },

    // ========== ADD PUB MODAL SEARCH ==========
    initAddPubSearch() {
        const addressInput = document.getElementById("pub-address");
        const addressResults = document.getElementById("address-results");

        if (!addressInput || !addressResults) {
            console.log("Add pub search elements not found (modal not loaded yet)");
            return;
        }

        // Clear any existing listeners
        addressInput.removeEventListener("input", this.addPubSearchHandler);
        
        // Create bound handler function
        this.addPubSearchHandler = Utils.debounce(async () => {
            const query = addressInput.value.trim();
            
            if (query.length < 3) {
                addressResults.style.display = "none";
                return;
            }
            
            try {
                // Show loading state
                addressResults.innerHTML = '<div class="address-result-item search-status">Searching...</div>';
                addressResults.style.display = "block";

                // Use the same unified search
                const results = await this.searchExternal(query);
                this.displayAddPubSearchResults(results, addressResults, query);
            } catch (error) {
                console.error("Add pub search error:", error);
                addressResults.innerHTML = '<div class="address-result-item">Search error</div>';
                addressResults.style.display = "block";
            }
        }, 150);
        
        addressInput.addEventListener("input", this.addPubSearchHandler);

        // Improved click outside handler for modal search
        this.addPubClickOutsideHandler = (e) => {
            if (!addressInput.contains(e.target) && 
                !addressResults.contains(e.target) &&
                !e.target.closest('.modal')) {
                addressResults.style.display = "none";
            }
        };
        
        // Remove existing listener if it exists
        document.removeEventListener('click', this.addPubClickOutsideHandler);
        document.addEventListener('click', this.addPubClickOutsideHandler);
    },

    // ========== SHARED SEARCH LOGIC ==========
    async searchExternal(query) {
        // Check cache first
        const cacheKey = this.normalizeCacheKey(query);
        if (this.cache.has(cacheKey)) {
            return this.cache.get(cacheKey);
        }

        // Queue the request to respect rate limits
        return new Promise((resolve) => {
            this.requestQueue.push({ query, resolve, cacheKey });
            if (!this.isProcessing) {
                this.processQueue();
            }
        });
    },

    normalizeCacheKey(query) {
        return query.toLowerCase().trim().replace(/[^a-z0-9\s]/g, '');
    },

    async processQueue() {
        if (this.requestQueue.length === 0) {
            this.isProcessing = false;
            return;
        }

        this.isProcessing = true;
        const { query, resolve, cacheKey } = this.requestQueue.shift();

        try {
            // Respect rate limiting
            const timeSinceLastRequest = Date.now() - this.lastRequestTime;
            if (timeSinceLastRequest < this.MIN_REQUEST_INTERVAL) {
                await new Promise(r => setTimeout(r, this.MIN_REQUEST_INTERVAL - timeSinceLastRequest));
            }

            const results = await this.performExternalSearch(query);
            this.lastRequestTime = Date.now();
            
            // Cache the results
            this.cache.set(cacheKey, results);
            this.cleanupCache();
            
            resolve(results);
        } catch (error) {
            console.error("External search error:", error);
            resolve([]);
        }

        // Process next in queue after a small delay
        setTimeout(() => this.processQueue(), 100);
    },

    async performExternalSearch(query) {
        // Build optimized single search URL
        const searchQuery = encodeURIComponent(query + ", Victoria, Australia");
        const victoriaBounds = "140.9,-39.2,150.0,-34.0";
        
        const url = `https://nominatim.openstreetmap.org/search?` +
                   `format=json&q=${searchQuery}&limit=8&addressdetails=1&` +
                   `viewbox=${victoriaBounds}&bounded=1&` +
                   `countrycodes=au&accept-language=en`;

        const response = await fetch(url, {
            headers: {
                'User-Agent': 'BeerSpy Melbourne App v0.2.19'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        return this.filterAndDeduplicateResults(data);
    },

    filterAndDeduplicateResults(data) {
        if (!data || !Array.isArray(data)) return [];
        
        const seen = new Set();
        
        return data
            .filter(place => {
                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);
                
                // Victoria bounds check (redundant but safe)
                if (lat < -39.2 || lat > -34.0 || lon < 140.9 || lon > 150.0) {
                    return false;
                }
                
                // Check not already in our database
                const isDuplicate = appState.pubs.some(pub => 
                    Math.abs(pub.lat - lat) < 0.001 && 
                    Math.abs(pub.lon - lon) < 0.001
                );
                
                if (isDuplicate) return false;
                
                // Deduplicate by coordinates
                const coordKey = `${lat.toFixed(3)},${lon.toFixed(3)}`;
                if (seen.has(coordKey)) return false;
                seen.add(coordKey);
                
                return true;
            })
            .slice(0, 6); // Allow more results for address search
    },

    // ========== EXISTING PUBS SEARCH ==========
    searchExistingPubs(query) {
        const lowerQuery = query.toLowerCase();
        return appState.pubs.filter(pub =>
            pub.name.toLowerCase().includes(lowerQuery) ||
            pub.address.toLowerCase().includes(lowerQuery)
        ).slice(0, 3);
    },

    // ========== MAIN SEARCH RESULTS DISPLAY ==========
    displayMainSearchResults(existingResults, geocodeResults, resultsDiv) {
        let resultsHTML = '';
        
        // Show existing pubs first
        if (existingResults.length > 0) {
            resultsHTML += existingResults.map(pub => `
                <div class="search-item existing-pub-indicator" data-type="existing" data-lat="${pub.lat}" data-lon="${pub.lon}">
                    <div class="place-name">🍺 ${pub.name}</div>
                    <div class="place-address">${pub.address}</div>
                    <div class="place-type">Existing pub • ${pub.beers.length} beers listed</div>
                </div>
            `).join('');
        }
        
        // Show new locations
        if (geocodeResults.length > 0) {
            resultsHTML += geocodeResults.slice(0, 3).map(place => {
                const pubName = this.extractPubName(place);
                const placeType = this.getPlaceType(place);
                
                return `
                    <div class="search-item new-location-indicator" 
                         data-type="new" 
                         data-lat="${place.lat}" 
                         data-lon="${place.lon}"
                         data-name="${pubName}"
                         data-address="${place.display_name}">
                        <div class="place-name">📍 ${pubName}</div>
                        <div class="place-address">${place.display_name}</div>
                        <div class="place-type">${placeType} • Click to add as new pub</div>
                    </div>
                `;
            }).join('');
        }
        
        if (resultsHTML) {
            resultsDiv.innerHTML = resultsHTML;
            resultsDiv.classList.add('show');
            this.attachMainSearchHandlers(resultsDiv);
        } else {
            resultsDiv.innerHTML = '<div class="search-item">No results found</div>';
            resultsDiv.classList.add('show');
        }
    },

    // ========== ADD PUB SEARCH RESULTS DISPLAY ==========
    displayAddPubSearchResults(results, addressResults, originalQuery) {
        if (!results || results.length === 0) {
            addressResults.innerHTML = '<div class="address-result-item">No locations found in Victoria</div>';
            addressResults.style.display = "block";
            return;
        }

        const resultsHTML = results.map(place => {
            const name = this.extractPubName(place);
            return `
                <div class="address-result-item" 
                    data-lat="${place.lat}" 
                    data-lon="${place.lon}" 
                    data-name="${name}" 
                    data-address="${place.display_name}">
                    <div class="place-name">${name}</div>
                    <div class="place-address">${place.display_name}</div>
                </div>
            `;
        }).join('');
        
        addressResults.innerHTML = resultsHTML;
        addressResults.style.display = "block";
        
        // Add click handlers for add pub modal
        addressResults.querySelectorAll('.address-result-item').forEach(item => {
            item.addEventListener('click', () => {
                const lat = parseFloat(item.dataset.lat);
                const lon = parseFloat(item.dataset.lon);
                const name = item.dataset.name;
                const address = item.dataset.address;
                
                // Check for duplicates
                const duplicate = appState.pubs.find(pub => 
                    Math.abs(pub.lat - lat) < 0.001 && 
                    Math.abs(pub.lon - lon) < 0.001
                );
                
                if (duplicate) {
                    Utils.showError(`This location already exists as "${duplicate.name}"`);
                    return;
                }
                
                Utils.hideError();
                
                // Fill in the form
                document.getElementById("pub-name").value = name;
                document.getElementById("pub-address").value = address;
                document.getElementById("pub-lat").value = lat;
                document.getElementById("pub-lon").value = lon;
                
                // Update map view
                if (appState.map) {
                    appState.map.setView([lat, lon], 16);
                }
                
                // Hide results
                addressResults.style.display = "none";
            });
        });
    },

    // ========== EVENT HANDLERS ==========
    attachMainSearchHandlers(resultsDiv) {
        resultsDiv.querySelectorAll('.search-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent event bubbling
                
                const lat = parseFloat(item.dataset.lat);
                const lon = parseFloat(item.dataset.lon);
                const type = item.dataset.type;
                
                if (type === 'existing') {
                    // Navigate to existing pub
                    appState.map.setView([lat, lon], 16);
                    resultsDiv.classList.remove('show');
                    document.getElementById("pub-search").value = "";
                    
                    // Open the popup for this pub
                    const marker = appState.markers.find(m => 
                        Math.abs(m.getLatLng().lat - lat) < 0.0001 && 
                        Math.abs(m.getLatLng().lng - lon) < 0.0001
                    );
                    if (marker) {
                        setTimeout(() => marker.fire('click'), 200);
                    }
                } else {
                    // Open "Add Pub" modal with pre-filled data
                    const pubName = item.dataset.name;
                    const address = item.dataset.address;
                    
                    document.getElementById("pub-name").value = pubName;
                    document.getElementById("pub-address").value = address;
                    document.getElementById("pub-lat").value = lat;
                    document.getElementById("pub-lon").value = lon;
                    
                    const modal = document.getElementById("add-pub-modal");
                    if (modal) {
                        modal.style.display = "flex";
                        // Re-initialize add pub search now that modal is visible
                        setTimeout(() => this.initAddPubSearch(), 100);
                        appState.map.setView([lat, lon], 16);
                    }
                    
                    resultsDiv.classList.remove('show');
                    document.getElementById("pub-search").value = "";
                }
            });
        });
    },

    // ========== UTILITY FUNCTIONS ==========
    extractPubName(placeData) {
        if (placeData.name) return placeData.name;
        
        if (placeData.display_name) {
            const parts = placeData.display_name.split(',');
            return parts[0].trim();
        }
        
        if (placeData.address) {
            const addr = placeData.address;
            if (addr.pub) return addr.pub;
            if (addr.bar) return addr.bar;
            if (addr.restaurant) return addr.restaurant;
            if (addr.house_number && addr.road) {
                return `${addr.house_number} ${addr.road}`;
            }
            if (addr.road) return addr.road;
        }
        
        return 'Unknown Location';
    },

    getPlaceType(place) {
        if (place.type === 'pub' || place.type === 'bar') return 'Pub/Bar';
        if (place.class === 'amenity' && place.type === 'restaurant') return 'Restaurant';
        if (place.class === 'tourism') return 'Tourism';
        if (place.class === 'shop') return 'Shop';
        return 'Location';
    },

    preloadCommonSearches() {
        const commonSearches = [
            "Melbourne CBD",
            "South Yarra", 
            "Richmond",
            "Fitzroy",
            "Collingwood",
            "St Kilda"
        ];
        
        // Stagger preloading
        commonSearches.forEach((search, index) => {
            setTimeout(() => {
                const cacheKey = this.normalizeCacheKey(search);
                if (!this.cache.has(cacheKey)) {
                    this.searchExternal(search);
                }
            }, (index + 1) * this.MIN_REQUEST_INTERVAL);
        });
    },

    cleanupCache() {
        if (this.cache.size > 100) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
    },

    // Debug function
    getCacheStats() {
        return {
            cacheSize: this.cache.size,
            queueLength: this.requestQueue.length,
            isProcessing: this.isProcessing,
            lastRequestTime: new Date(this.lastRequestTime).toLocaleTimeString()
        };
    }
};

function getSelectedDays(containerSelector) {
            const container = document.querySelector(containerSelector);
            const activeDayButtons = container.querySelectorAll('.day-btn.active');
            return Array.from(activeDayButtons).map(btn => btn.dataset.day);
        }

        // =====================================
        // MODAL MANAGEMENT
        // =====================================
        const ModalManager = {
            init() {
                this.setupAddPubModal();
                this.setupSubmitPriceModal();
            },

                validateBeerPrice(category, size, price) {
                    const priceRanges = {
                        pint: { min: 4, max: 18, typical: [7, 16] },
                        schooner: { min: 3, max: 15, typical: [6, 11] },
                        pot: { min: 2, max: 12, typical: [4, 8] },
                        bottle: { min: 3, max: 15, typical: [5, 11] },
                        can: { min: 3, max: 12, typical: [4, 9] },
                        jug: { min: 8, max: 35, typical: [15, 25] }
                    };

                    const range = priceRanges[size];
                    if (!range) return { valid: true }; // Unknown size, allow it

                    // Hard limits - definitely wrong
                    if (price < range.min || price > range.max) {
                        return { 
                            valid: false, 
                            message: `${size} prices typically range from $${range.min}-$${range.max}. Please double-check.` 
                        };
                    }

                    // Soft warnings - unusual but possible
                    if (price < range.typical[0] || price > range.typical[1]) {
                        return { 
                            valid: true, 
                            warning: true,
                            message: `That's ${price < range.typical[0] ? 'quite cheap' : 'quite expensive'} for a ${size}. Is this correct?` 
                        };
                    }

                    return { valid: true };
                },

            setupAddPubModal() {
                const modal = document.getElementById("add-pub-modal");
                const addPubBtn = document.getElementById("add-pub-btn");
                const closeBtn = document.getElementById("close-add-pub");
                const cancelBtn = document.getElementById("cancel-add-pub");
                const submitBtn = document.getElementById("submit-pub-btn");

                if (addPubBtn) {
                    addPubBtn.addEventListener("click", () => {
                        modal.style.display = "flex";
                        this.resetAddPubForm();
                        Utils.hideError();
                        
                        // Initialize add pub search AFTER modal is shown
                        setTimeout(() => {
                            SearchManager.initAddPubSearch();
                        }, 100);
                    });
                }

                if (closeBtn) {
                    closeBtn.addEventListener("click", () => {
                        modal.style.display = "none";
                        Utils.hideError();
                    });
                }

                if (cancelBtn) {
                    cancelBtn.addEventListener("click", () => {
                        modal.style.display = "none";
                        Utils.hideError();
                    });
                }

                if (submitBtn) {
                    submitBtn.addEventListener("click", () => this.handleAddPubSubmit());
                }

                // Setup happy hour checkbox
                const happyHourCheckbox = document.getElementById("is-happy-hour");
                const happyHourDetails = document.getElementById("happy-hour-details");
                
                if (happyHourCheckbox && happyHourDetails) {
                    happyHourCheckbox.addEventListener("change", () => {
                        happyHourDetails.style.display = happyHourCheckbox.checked ? "block" : "none";
                    });
                }

                // Setup address search
                this.setupDayToggleButtons('#add-pub-modal');

            },
                        // Add this helper function to ModalManager
            setupDayToggleButtons(containerSelector) {
                const container = document.querySelector(containerSelector);
                if (!container) return;
                
                const dayButtons = container.querySelectorAll('.day-btn');
                dayButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        btn.classList.toggle('active');
                    });
                });
            },
             async handleAddPubSubmit() {
                const elements = {
                    name: document.getElementById("pub-name"),
                    address: document.getElementById("pub-address"),
                    lat: document.getElementById("pub-lat"),
                    lon: document.getElementById("pub-lon"),
                    category: document.getElementById("beer-category"),
                    size: document.getElementById("beer-size"),
                    price: document.getElementById("beer-price")
                };

                // Validate required elements exist
                for (const [key, element] of Object.entries(elements)) {
                    if (!element) {
                        Utils.showError(`${key} field not found`);
                        return;
                    }
                }

                const values = {
                    name: elements.name.value.trim(),
                    address: elements.address.value.trim(),
                    lat: elements.lat.value.trim(),
                    lon: elements.lon.value.trim(),
                    category: elements.category.value,
                    size: elements.size.value,
                    price: parseFloat(elements.price.value)
                };

                // Validate required fields
                if (!values.name) {
                    Utils.showError("Pub name is required");
                    return;
                }
                if (!values.address) {
                    Utils.showError("Address is required");
                    return;
                }
                if (!values.lat || !values.lon || isNaN(values.lat) || isNaN(values.lon)) {
                    Utils.showError("Please validate the location before submitting");
                    return;
                }
                if (!values.category || !values.size || !values.price || isNaN(values.price)) {
                    Utils.showError("Please enter valid beer details");
                    return;
                }

                // Get happy hour data
                const isHappyHour = document.getElementById("is-happy-hour").checked;
                const happyHourStart = document.getElementById("happy-hour-start").value;
                const happyHourEnd = document.getElementById("happy-hour-end").value;
                const happyHourDaysSelect = document.getElementById("happy-hour-days");
                const happyHourDays = getSelectedDays('#add-pub-modal');

                const newPub = {
                    id: appState.pubs.length + 1,
                    name: values.name,
                    address: values.address,
                    lat: parseFloat(values.lat),
                    lon: parseFloat(values.lon),
                    beers: [{
                        name: values.category,
                        size: values.size,
                        price: values.price,
                        is_happy_hour: isHappyHour,
                        happy_hour_start: isHappyHour ? happyHourStart : null,
                        happy_hour_end: isHappyHour ? happyHourEnd : null,
                        happy_hour_days: isHappyHour ? happyHourDays : null
                    }]
                };
                const priceValidation = this.validateBeerPrice(values.category, values.size, values.price);
                
                if (!priceValidation.valid) {
                    Utils.showError(priceValidation.message);
                    return;
                }

                if (priceValidation.warning) {
                    // Show warning but allow user to proceed
                    const proceed = confirm(`⚠️ ${priceValidation.message}\n\nClick OK to submit anyway, or Cancel to edit.`);
                    if (!proceed) return;
                }
                try {
                    await DataManager.updatePubInDatabase(newPub);
                    document.getElementById("add-pub-modal").style.display = "none";
                } catch (err) {
                    Utils.showError(`Failed to save pub: ${err.message}`);
                }
            },

            resetAddPubForm() {
                const fields = ["pub-name", "pub-address", "pub-lat", "pub-lon", "beer-price"];
                fields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = "";
                });

                const selects = ["beer-category", "beer-size"];
                selects.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.selectedIndex = 0;
                });

                const checkbox = document.getElementById("is-happy-hour");
                if (checkbox) {
                    checkbox.checked = false;
                    document.getElementById("happy-hour-details").style.display = "none";
                }
            },

            setupSubmitPriceModal() {
                const modal = document.getElementById("submit-price-modal");
                const closeBtn = document.getElementById("close-submit-price");
                const cancelBtn = document.getElementById("cancel-submit-price");
                const submitBtn = document.getElementById("submit-price-btn");

                if (closeBtn) {
                    closeBtn.addEventListener("click", () => {
                        modal.style.display = "none";
                    });
                }

                if (cancelBtn) {
                    cancelBtn.addEventListener("click", () => {
                        modal.style.display = "none";
                    });
                }

                if (submitBtn) {
                    submitBtn.addEventListener("click", () => this.handleSubmitPriceSubmit());
                }

                // Setup happy hour checkbox for the simplified form
                const happyHourCheckbox = document.getElementById("is-happy-hour-price");
                const happyHourDetails = document.getElementById("happy-hour-price-details");
                
                if (happyHourCheckbox && happyHourDetails) {
                    happyHourCheckbox.addEventListener("change", () => {
                        happyHourDetails.style.display = happyHourCheckbox.checked ? "block" : "none";
                    });
                }
                this.setupDayToggleButtons('#submit-price-modal');

            },

            openSubmitPriceModal(pub) {
                const modal = document.getElementById("submit-price-modal");
                if (!modal || !pub) return;

                // Reset form
                this.clearPriceForm();
                
                // Show modal
                modal.style.display = "flex";
            },



            async handleSubmitPriceSubmit() {
                if (!appState.currentPubForPriceUpdate) {
                    alert("No pub selected.");
                    return;
                }

                // Get form values from the simplified form
                const categorySelect = document.getElementById("beer-category-select");
                const sizeSelect = document.getElementById("beer-size-select");
                const priceInput = document.getElementById("beer-price-input");

                const selectedCategory = categorySelect?.value;
                const selectedSize = sizeSelect?.value;
                const selectedPrice = parseFloat(priceInput?.value);

                // Validate inputs
                if (!selectedCategory || !selectedSize || !selectedPrice || isNaN(selectedPrice) || selectedPrice <= 0) {
                    alert("Please fill in all required fields with valid values.");
                    return;
                }

                // Get happy hour data
                const isHappyHour = document.getElementById("is-happy-hour-price")?.checked || false;
                const happyHourStart = document.getElementById("happy-hour-price-start")?.value;
                const happyHourEnd = document.getElementById("happy-hour-price-end")?.value;
                const happyHourDays = getSelectedDays('#submit-price-modal');


                const beerData = {
                    name: selectedCategory,
                    size: selectedSize,
                    price: selectedPrice,
                    is_happy_hour: isHappyHour,
                    happy_hour_start: isHappyHour ? happyHourStart : null,
                    happy_hour_end: isHappyHour ? happyHourEnd : null,
                    happy_hour_days: isHappyHour ? happyHourDays : null
                };
                const priceValidation = this.validateBeerPrice(selectedCategory, selectedSize, selectedPrice);
        
                    if (!priceValidation.valid) {
                        alert(priceValidation.message);
                        return;
                    }

                    if (priceValidation.warning) {
                        const proceed = confirm(`⚠️ ${priceValidation.message}\n\nClick OK to submit anyway, or Cancel to edit.`);
                        if (!proceed) return;
                    }

                try {
                        // Use the new method instead of updating the entire pub
                    await DataManager.updateSingleBeerPrice(
                            appState.currentPubForPriceUpdate.name,
                            appState.currentPubForPriceUpdate.lat,
                            appState.currentPubForPriceUpdate.lon,
                            beerData
                        );
                
                    document.getElementById("submit-price-modal").style.display = "none";
                    
                    // Clear form fields
                    this.clearPriceForm();
                } catch (error) {
                    console.error("Failed to update pub prices:", error);
                    alert("Failed to update pub prices. Please try again.");
                }
            },

            clearPriceForm() {
                //test
                const clearElements = [
                    "beer-category-select", "beer-size-select", "beer-price-input"
                ];
                clearElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.value = "";
                });
                
                // Reset happy hour checkbox and hide details
                const happyHourCheckbox = document.getElementById("is-happy-hour-price");
                const happyHourDetails = document.getElementById("happy-hour-price-details");
                
                if (happyHourCheckbox) {
                    happyHourCheckbox.checked = false;
                }
                if (happyHourDetails) {
                    happyHourDetails.style.display = "none";
                }
            }
        };

        // =====================================
        // STATISTICS
        // =====================================
        const Statistics = {
            update() {
                const totalPubs = appState.pubs.length;
                
                // Count total price entries for current size AND collect valid prices
                let totalPriceEntries = 0;
                const prices = [];
                
                appState.pubs.forEach((pub) => {
                    const beersForSize = pub.beers.filter((beer) => beer.size === appState.currentSize);
                    totalPriceEntries += beersForSize.length; // Count all entries for this size
                    
                    beersForSize.forEach((beer) => {
                        // Only include valid numbers in average calculation
                        if (typeof beer.price === 'number' && !isNaN(beer.price) && beer.price > 0) {
                            prices.push(beer.price);
                        }
                    });
                });

                // Calculate average price using only valid prices
                const avgPriceValue = prices.length > 0
                    ? (prices.reduce((total, price) => total + price, 0) / prices.length).toFixed(2)
                    : "N/A";

                // Update display elements
                const elements = {
                    pubsCount: document.getElementById("pubs-count"),
                    beersCount: document.getElementById("beers-count"),
                    avgPrice: document.getElementById("avg-price")
                };

                if (elements.pubsCount) {
                    elements.pubsCount.textContent = totalPubs;
                }
                
                if (elements.beersCount) {
                    elements.beersCount.textContent = totalPriceEntries; // ✅ Now shows price entries for current size
                }
                
                if (elements.avgPrice) {
                    elements.avgPrice.textContent = avgPriceValue === "N/A" ? "N/A" : `$${avgPriceValue}`;
                }

                // Debug info (remove in production)
                console.log(`📊 Stats: ${totalPubs} pubs, ${totalPriceEntries} ${appState.currentSize} entries, ${prices.length} valid prices, avg: $${avgPriceValue}`);
            }
        };
        // =====================================
        // CHARTS MANAGER
        // =====================================
        const ChartsManager = {
            trendChart: null,
            histogramChart: null,

            init() {
                this.initializeTrendChart();
                this.initializeHistogramChart();
            },

            initializeTrendChart() {
                const ctx = document.getElementById('price-trend-chart');
                if (!ctx) return;

            this.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Price',
                        data: [],
                        borderColor: '#1f77b4',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 3,
                        pointHoverBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    backgroundColor: '#ffffff',
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#d0d0d0',
                                lineWidth: 0.8,
                                drawBorder: false
                            },
                            border: {
                                color: '#000000',
                                width: 1.2
                            },
                            ticks: {
                                color: '#000000',
                                font: {
                                    family: 'Arial, sans-serif',
                                    size: 10
                                },
                                padding: 8,
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Price (AUD)',
                                color: '#000000',
                                font: {
                                    family: 'Arial, sans-serif',
                                    size: 11,
                                    weight: 'normal'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: '#d0d0d0',
                                lineWidth: 0.8,
                                drawBorder: false
                            },
                            border: {
                                color: '#000000',
                                width: 1.2
                            },
                            ticks: {
                                color: '#000000',
                                font: {
                                    family: 'Arial, sans-serif',
                                    size: 10
                                },
                                padding: 8,
                                maxTicksLimit: 8
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#000000',
                                font: {
                                    family: 'Arial, sans-serif',
                                    size: 11,
                                    weight: 'normal'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#000000',
                            bodyColor: '#000000',
                            borderColor: '#000000',
                            borderWidth: 1,
                            cornerRadius: 2,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Average: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: '#1f77b4',
                            hoverBorderColor: '#000000',
                            hoverBorderWidth: 1
                        }
                    }
                }
            });
            },

            initializeHistogramChart() {
                const ctx = document.getElementById('price-histogram-chart');
                if (!ctx) return;
                this.histogramChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Number of Prices',
                            data: [],
                            backgroundColor: '#1f77b4',
                            borderColor: '#1f77b4',
                            borderWidth: 0.5,
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        backgroundColor: '#ffffff',
                        layout: {
                            padding: {
                                top: 10,
                                right: 10,
                                bottom: 10,
                                left: 10
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#d0d0d0',
                                    lineWidth: 0.8,
                                    drawBorder: false
                                },
                                border: {
                                    color: '#000000',
                                    width: 1.2
                                },
                                ticks: {
                                    stepSize: 1,
                                    color: '#000000',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 10
                                    },
                                    padding: 8
                                },
                                title: {
                                    display: true,
                                    text: 'Frequency',
                                    color: '#000000',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 11,
                                        weight: 'normal'
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: true,
                                    color: '#e0e0e0', /* ✅ Light grid lines */
                                    lineWidth: 0.5

                                },
                                border: {
                                    color: '#000000',
                                    width: 1.2
                                },
                                ticks: {
                                    color: '#000000',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 10
                                    },
                                    padding: 8,
                                    maxRotation: 0,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        return index % 2 === 0 ? label : label.replace('$', '');
                        }
                                },
                                title: {
                                    display: true,
                                    text: 'Price Range (AUD)',
                                    color: '#000000',
                                    font: {
                                        family: 'Arial, sans-serif',
                                        size: 11,
                                        weight: 'normal'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#000000',
                                bodyColor: '#000000',
                                borderColor: '#000000',
                                borderWidth: 1,
                                cornerRadius: 2,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + ' prices';
                                    }
                                }
                            }
                        }
                    }
                });
                            },

            updateCharts() {
                console.log("📊 Charts update:", {
                    pubsCount: appState.pubs.length,
                    currentSize: appState.currentSize,
                    totalBeers: appState.pubs.reduce((sum, pub) => sum + pub.beers.length, 0)
                });

                if (!appState.pubs.length) {
                    this.showEmptyState();
                    return;
                }

                const priceData = this.collectPriceData();
                console.log("📊 Price data for charts:", priceData.length, priceData);
                
                if (priceData.length < 2) {
                    this.showEmptyState();
                    return;
                }

                this.hideEmptyState();
                this.updateTrendChart(priceData);
                this.updateHistogramChart(priceData);
            },

            collectPriceData() {
                const priceData = [];
                
                // Only collect data from pubs that actually have markers visible on the map
                appState.pubs.forEach(pub => {
                    const beersForSize = pub.beers.filter(beer => beer.size === appState.currentSize);
                    
                    // Skip pubs that don't have any beers of the current size (no marker on map)
                    if (beersForSize.length === 0) return;
                    
                    // Only include the beer prices that would actually be displayed
                    // This matches the same logic used in renderMarkers()
                    const regularBeerMap = new Map();
                    const happyHourBeerMap = new Map();
                    
                    beersForSize.forEach(beer => {
                        if (typeof beer.price !== 'number' || isNaN(beer.price) || beer.price <= 0) return;
                        
                        const beerTime = beer.last_updated ? new Date(beer.last_updated) : new Date(0);
                        
                        if (beer.is_happy_hour) {
                            const existing = happyHourBeerMap.get(beer.name);
                            if (!existing || beerTime > existing.time) {
                                happyHourBeerMap.set(beer.name, { beer, time: beerTime });
                            }
                        } else {
                            const existing = regularBeerMap.get(beer.name);
                            if (!existing || beerTime > existing.time) {
                                regularBeerMap.set(beer.name, { beer, time: beerTime });
                            }
                        }
                    });
                    
                    // Add regular beer prices
                    regularBeerMap.forEach(({beer}) => {
                        const date = beer.last_updated ? new Date(beer.last_updated) : new Date();
                        priceData.push({
                            date: date,
                            price: beer.price,
                            dateString: date.toISOString().split('T')[0]
                        });
                    });
                    
                    // Add happy hour prices (both active and inactive for historical data)
                    happyHourBeerMap.forEach(({beer}) => {
                        const date = beer.last_updated ? new Date(beer.last_updated) : new Date();
                        priceData.push({
                            date: date,
                            price: beer.price,
                            dateString: date.toISOString().split('T')[0]
                        });
                    });
                });

                return priceData.sort((a, b) => a.date - b.date);
            },

            updateTrendChart(priceData) {
                if (!this.trendChart) return;

                // Group by date and calculate daily averages
                const dailyPrices = new Map();
                
                priceData.forEach(item => {
                    if (!dailyPrices.has(item.dateString)) {
                        dailyPrices.set(item.dateString, []);
                    }
                    dailyPrices.get(item.dateString).push(item.price);
                });

                // Calculate averages and format for chart
                const labels = [];
                const averages = [];

                Array.from(dailyPrices.entries())
                    .sort(([a], [b]) => a.localeCompare(b))
                    .forEach(([dateString, prices]) => {
                        const average = prices.reduce((sum, price) => sum + price, 0) / prices.length;
                        labels.push(this.formatDateLabel(dateString));
                        averages.push(average);
                    });

                this.trendChart.data.labels = labels;
                this.trendChart.data.datasets[0].data = averages;
                this.trendChart.data.datasets[0].label = `Average ${appState.currentSize.charAt(0).toUpperCase() + appState.currentSize.slice(1)} Price`;
                this.trendChart.update();
            },

            updateHistogramChart(priceData) {
                if (!this.histogramChart) return;

                const prices = priceData.map(item => item.price);
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                
                // Create bins with fixed 50c increments for better granularity
                const binSize = 0.5; // 50c increments
                const minBin = Math.floor(min * 2) / 2; // Round down to nearest 50c
                const maxBin = Math.ceil(max * 2) / 2; // Round up to nearest 50c
                const binCount = Math.ceil((maxBin - minBin) / binSize);
                
                const bins = [];
                const labels = [];

                for (let i = 0; i < binCount; i++) {
                    const binStart = minBin + (i * binSize);
                    
                    bins.push(0);
                    
                    // Format labels to show 50c ranges (e.g., $8.0, $8.5, $9.0)
                    labels.push(`$${binStart.toFixed(1)}`);
                }

                // Count prices in each bin
                prices.forEach(price => {
                    const binIndex = Math.min(Math.floor((price - minBin) / binSize), binCount - 1);
                    if (binIndex >= 0) {
                        bins[binIndex]++;
                    }
                });

                this.histogramChart.data.labels = labels;
                this.histogramChart.data.datasets[0].data = bins;
                this.histogramChart.data.datasets[0].label = `${appState.currentSize.charAt(0).toUpperCase() + appState.currentSize.slice(1)} Prices`;
                this.histogramChart.update();
            },

            formatDateLabel(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays}d ago`;
                
                return date.toLocaleDateString('en-AU', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            },

            showEmptyState() {
                this.hideCharts();
                document.getElementById('price-trend-empty').style.display = 'flex';
                document.getElementById('price-histogram-empty').style.display = 'flex';
            },

            hideEmptyState() {
                this.showCharts();
                document.getElementById('price-trend-empty').style.display = 'none';
                document.getElementById('price-histogram-empty').style.display = 'none';
            },

            showCharts() {
                document.getElementById('price-trend-chart').style.display = 'block';
                document.getElementById('price-histogram-chart').style.display = 'block';
            },

            hideCharts() {
                document.getElementById('price-trend-chart').style.display = 'none';
                document.getElementById('price-histogram-chart').style.display = 'none';
            }
        };
        

        // =====================================
        // EVENT LISTENERS
        // =====================================

        const EventListeners = {
            init() {
                // Size filter buttons (existing code)
                document.querySelectorAll(".size-btn").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        document.querySelectorAll(".size-btn").forEach((b) => b.classList.remove("active"));
                        btn.classList.add("active");
                        appState.currentSize = btn.dataset.size;
                        if (appState.pubs.length > 0) {
                            MapManager.renderMarkers();
                            PubListManager.updatePubList(); // Add this line
                        }
                    });
                });

                // Add toggle buttons for Best Value/Closest
                document.querySelectorAll(".toggle-btn").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        document.querySelectorAll(".toggle-btn").forEach((b) => b.classList.remove("active"));
                        btn.classList.add("active");
                        appState.currentListMode = btn.dataset.mode;
                        PubListManager.updatePubList();
                    });
                });
            }
        };

        //PUB LIST MANAGER//
        const PubListManager = {
            init() {
                // Set initial mode
                appState.currentListMode = "value";
            },

            updatePubList() {
                if (!appState.userLocation || !appState.pubs.length) {
                    this.renderEmptyList();
                    return;
                }

                const pubsWithScores = this.calculatePubScores();
                const sortedPubs = this.sortPubs(pubsWithScores);
                this.renderPubList(sortedPubs.slice(0, 5)); // Show top 5
            },

            calculatePubScores() {
                return appState.pubs.map(pub => {
                    const beersForSize = pub.beers.filter(beer => beer.size === appState.currentSize);
                    
                    if (beersForSize.length === 0) {
                        return null; // No beers of this size
                    }

                    const distance = Utils.calculateDistance(
                        appState.userLocation.lat, 
                        appState.userLocation.lon, 
                        pub.lat, 
                        pub.lon
                    );

                    // ✅ Use SAME logic as map markers - group by beer name and get most recent for each
                    const regularBeerMap = new Map();
                    const happyHourBeerMap = new Map();
                    
                    beersForSize.forEach(beer => {
                        const beerTime = beer.last_updated ? new Date(beer.last_updated) : new Date(0);
                        
                        if (beer.is_happy_hour) {
                            const existingHappyHour = happyHourBeerMap.get(beer.name);
                            if (!existingHappyHour || beerTime > existingHappyHour.time) {
                                happyHourBeerMap.set(beer.name, { beer, time: beerTime });
                            }
                        } else {
                            const existingRegular = regularBeerMap.get(beer.name);
                            if (!existingRegular || beerTime > existingRegular.time) {
                                regularBeerMap.set(beer.name, { beer, time: beerTime });
                            }
                        }
                    });

                    // Check for currently active happy hour beers
                    const activeHappyHourBeers = Array.from(happyHourBeerMap.values())
                        .filter(item => MapManager.checkIfCurrentlyHappyHour(item.beer))
                        .map(item => item.beer);

                    // Get regular beers (most recent for each category)
                    const regularBeers = Array.from(regularBeerMap.values()).map(item => item.beer);

                    // Determine cheapest available price and its type
                    let cheapestPrice = null;
                    let isHappyHourPrice = false;

                    // Prioritize active happy hour prices
                    if (activeHappyHourBeers.length > 0) {
                        cheapestPrice = Math.min(...activeHappyHourBeers.map(b => b.price));
                        isHappyHourPrice = true;
                    } else if (regularBeers.length > 0) {
                        cheapestPrice = Math.min(...regularBeers.map(b => b.price));
                        isHappyHourPrice = false;
                    }

                    if (cheapestPrice === null) return null; // No available prices

                    // Calculate value score using the cheapest available price
                    const distanceWeight = Math.max(0.1, distance * 0.5);
                    const valueScore = cheapestPrice * 0.5 * distanceWeight;

                    return {
                        pub,
                        distance,
                        cheapestPrice,
                        isHappyHourPrice,
                        valueScore
                    };
                }).filter(item => item !== null);
            },

            sortPubs(pubsWithScores) {
                if (appState.currentListMode === "distance") {
                    return pubsWithScores.sort((a, b) => a.distance - b.distance);
                } else {
                    // Sort by value score (lower is better)
                    return pubsWithScores.sort((a, b) => a.valueScore - b.valueScore);
                }
            },

            renderPubList(sortedPubs) {
                const pubListElement = document.getElementById("pub-list");
                if (!pubListElement) return;

                if (sortedPubs.length === 0) {
                    this.renderEmptyList();
                    return;
                }

                const listHTML = sortedPubs.map((item, index) => {
                    const { pub, distance, cheapestPrice, isHappyHourPrice, valueScore } = item;
                    
                    const distanceText = `${distance.toFixed(1)}km away`;
                    const priceText = Utils.formatPrice(cheapestPrice);
                    const happyHourIndicator = isHappyHourPrice ? ' 🎉' : '';
                    
                    let valueText = '';
                    if (appState.currentListMode === "value") {
                        const rank = index + 1;
                        valueText = `<div class="value-score">#${rank} Best Value</div>`;
                    }

                    return `
                        <div class="pub-list-item" data-lat="${pub.lat}" data-lon="${pub.lon}">
                            <div class="pub-info">
                                <h4>${pub.name}${happyHourIndicator}</h4>
                                <div class="distance">${distanceText}</div>
                                ${valueText}
                            </div>
                            <div class="pub-price">${priceText}</div>
                        </div>
                    `;
                }).join('');

                pubListElement.innerHTML = listHTML;

                // Add click handlers
                pubListElement.querySelectorAll('.pub-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lon = parseFloat(item.dataset.lon);
                        
                        // Navigate to pub on map
                        appState.map.setView([lat, lon], 16);
                        
                        // Find and click the marker
                        const marker = appState.markers.find(m => 
                            Math.abs(m.getLatLng().lat - lat) < 0.0001 && 
                            Math.abs(m.getLatLng().lng - lon) < 0.0001
                        );
                        if (marker) {
                            setTimeout(() => marker.fire('click'), 200);
                        }
                    });
                });
            },

            renderEmptyList() {
                const pubListElement = document.getElementById("pub-list");
                if (!pubListElement) return;

                let message = "No pubs found";
                if (!appState.userLocation) {
                    message = "Location needed for recommendations";
                } else if (appState.pubs.length === 0) {
                    message = "No pubs in database yet";
                } else {
                    message = `No ${appState.currentSize}s available nearby`;
                }

                pubListElement.innerHTML = `
                    <div class="pub-list-item" style="justify-content: center; color: var(--text-medium);">
                        ${message}
                    </div>
                `;
            }
        };

        

        // =====================================
        // APPLICATION INITIALIZATION
        // =====================================
        document.addEventListener("DOMContentLoaded", async function () {
            try {
                console.log("Initializing BeerSpy application...");
                
                // Initialize application state
                appState.init();
                
                // Initialize map with location detection
                await MapManager.initialize();
                
                // Setup event listeners
                EventListeners.init();
                
                // Initialize modal management
                ModalManager.init();
                
                // Initialize search functionality
                SearchManager.init();

                ChartsManager.init();
                                
                // Fetch and display data
                PubListManager.init();
                await DataManager.fetchBeerPrices();

                
                console.log("BeerSpy application initialized successfully!");
                
            } catch (error) {
                console.error("BeerSpy initialization error:", error);
                Utils.showError(`App failed to initialize: ${error.message}`);
            }
        });
        //Test!
                // PWA Install prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show your custom install button
        const installButton = document.createElement('button');
        installButton.textContent = '📱 Install App';
        installButton.style.cssText = `
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1000;
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response: ${outcome}`);
            deferredPrompt = null;
            installButton.remove();
            }
        });
        
        document.body.appendChild(installButton);
        });
    </script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}
</script>
</body>
</html>