<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeerSpy Melbourne - Live Beer Prices Map</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3417/3417754.png" type="image/png">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/umd/supabase.min.js"></script>

    <style>
        /* ========== CSS VARIABLES & RESET ========== */
        :root {
            --primary: #2c3e50;
            --primary-light: #3c5975;
            --secondary: #286e9c;
            --secondary-dark: #2980b9;
            --accent: #e6bc22;
            --accent-dark: #d7782f;
            --warning: #e74c3c;
            --success: #27ae60;
            --light-gray: #f5f7f9;
            --medium-gray: #ecf0f1;
            --text-dark: #2c3e50;
            --text-medium: #7f8c8d;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Open Sans', 'Helvetica', Arial, sans-serif;
        }
        
        body {
            background: var(--light-gray);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== LAYOUT COMPONENTS ========== */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            box-shadow: var(--shadow);
        }
        
        .header__container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo__icon {
            font-size: 2.2rem;
        }
        
        .logo__title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .logo__subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 0;
        }

        .main-container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        /* ========== MAP SECTION ========== */
        .map-section {
            flex: 1;
            position: relative;
            height: calc(100vh - 160px);
            min-height: 400px;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .map {
            height: 100%;
            background: var(--light-gray);
        }

        .search-container {
            position: absolute;
            top: 18px;
            right: 18px;
            z-index: 1000;
            width: 300px;
        }

        .search-bar {
            display: flex;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .search-bar__input {
            flex-grow: 1;
            padding: 12px 15px;
            border: none;
            font-size: 1rem;
            outline: none;
        }
        
        .search-bar__button {
            background: var(--secondary);
            color: white;
            border: none;
            width: 50px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .search-bar__button:hover {
            background: var(--secondary-dark);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            box-shadow: var(--shadow);
            border-radius: 0 0 4px 4px;
            z-index: 1001;
            display: none;
        }

        .search-results--show {
            display: block;
        }

        .search-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-item:hover {
            background: #f1f5f9;
        }

        .search-item--existing {
            background: #e8f5e8;
            border-left: 3px solid var(--success);
        }

        .search-item--new {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
        }

        /* ========== CONTROLS SECTION ========== */
        .controls-section {
            width: 300px;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
        }
        
        .control-group__title {
            margin-bottom: 12px;
            color: var(--primary);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .size-filter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .size-btn {
            padding: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: var(--text-dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .size-btn:hover, .size-btn--active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .add-pub-btn {
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-pub-btn:hover {
            background: var(--accent-dark);
        }
        
        .stats-container {
            display: flex;
            gap: 15px;
            text-align: center;
        }
        
        .stat-card {
            flex: 1;
            background: var(--light-gray);
            border-radius: 4px;
            padding: 10px;
        }
        
        .stat-card__value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-card__label {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        /* ========== MAP MARKERS ========== */
        .price-bubble {
            background: var(--accent);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 0.9rem;
        }

        .price-bubble--recent { background: var(--success); }
        .price-bubble--average { background: #3498db; }
        .price-bubble--old { background: var(--warning); }
        .price-bubble--happy-hour { 
            background: #ff69b4; 
            animation: pulse-pink 2s infinite;
        }

        @keyframes pulse-pink {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .user-location-marker {
            background: none;
            border: none;
        }

        .user-location-icon {
            font-size: 20px;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .modal--show {
            display: flex;
        }
        
        .modal__content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal__header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal__title {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .modal__close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal__close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal__body {
            padding: 20px;
        }
        
        .modal__footer {
            padding: 15px 20px;
            background: var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group__label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-group__input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-group__input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn--cancel {
            background: white;
            border: 1px solid #ddd;
            color: var(--text-dark);
        }
        
        .btn--cancel:hover {
            background: #f5f5f5;
        }
        
        .btn--submit {
            background: var(--accent);
            color: white;
        }
        
        .btn--submit:hover {
            background: var(--accent-dark);
        }

        .error {
            color: var(--warning);
            font-weight: 600;
            background: #fdecea;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .error--show {
            display: block;
        }

        /* ========== POPUP STYLES ========== */
        .pub-popup {
            min-width: 240px;
            max-width: 300px;
        }
        
        .pub-popup__title {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .pub-popup__address {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-bottom: 15px;
        }
        
        .beer-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        .beer-table th {
            text-align: left;
            padding: 8px;
            background: var(--medium-gray);
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: var(--text-medium);
        }
        
        .beer-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .beer-price {
            text-align: right;
            color: var(--warning);
            font-weight: 600;
        }

        .beer-price--happy-hour {
            background: #ff69b4;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .last-updated {
            font-size: 0.8rem;
            color: #95a5a6;
            margin-bottom: 15px;
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
        }
        
        .popup-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .popup-btn:hover {
            background: var(--secondary-dark);
        }

        /* ========== FOOTER ========== */
        .footer {
            background: var(--primary);
            color: white;
            text-align: center;
            padding: 15px;
            margin-top: auto;
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 767px) {
            .main-container {
                flex-direction: column;
                padding: 10px;
            }
            
            .map-section {
                height: 60vh;
            }
            
            .controls-section {
                width: 100%;
                order: 2;
            }
            
            .search-container {
                left: 10px;
                right: 10px;
                width: auto;
            }
            
            .size-filter {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-card {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
            }
        }

        @media (min-width: 768px) {
            .controls-section {
                order: 2;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header__container">
            <div class="logo">
                <div class="logo__icon">🍺</div>
                <div>
                    <h1 class="logo__title">BeerSpy</h1>
                    <p class="logo__subtitle">yum yum dot com</p>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Map Section -->
        <div class="map-section">
            <div id="map" class="map"></div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="search-input" class="search-bar__input" placeholder="Search places in Melbourne...">
                    <button class="search-bar__button"><i class="fas fa-search"></i></button>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
        </div>
        
        <!-- Controls Section -->
        <div class="controls-section">
            <!-- Size Filter -->
            <div class="control-group">
                <h3 class="control-group__title">Beer Size</h3>
                <div class="size-filter" id="size-filter">
                    <button class="size-btn size-btn--active" data-size="pint">Pint</button>
                    <button class="size-btn" data-size="schooner">Schooner</button>
                    <button class="size-btn" data-size="pot">Pot</button>
                    <button class="size-btn" data-size="bottle">Bottle</button>
                    <button class="size-btn" data-size="can">Can</button>
                    <button class="size-btn" data-size="jug">Jug</button>
                </div>
            </div>
            
            <!-- Add Pub Button -->
            <div class="control-group">
                <h3 class="control-group__title">Add a New Pub</h3>
                <button id="add-pub-btn" class="add-pub-btn">
                    <i class="fas fa-plus"></i> Enter Pub Details
                </button>
            </div>
            
            <!-- Statistics -->
            <div class="control-group stats-container">
                <div class="stat-card">
                    <div class="stat-card__value" id="pubs-count">0</div>
                    <div class="stat-card__label">Pubs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value" id="beers-count">0</div>
                    <div class="stat-card__label">Beers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__value" id="avg-price">-</div>
                    <div class="stat-card__label">Avg Price</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Pub Modal -->
    <div id="add-pub-modal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Add New Pub</h2>
                <button class="modal__close" id="close-add-pub">&times;</button>
            </div>
            <div class="modal__body">
                <div id="add-pub-error" class="error"></div>
                <form id="add-pub-form">
                    <div class="form-group">
                        <label class="form-group__label" for="pub-name">Pub Name *</label>
                        <input type="text" id="pub-name" class="form-group__input" required placeholder="Enter pub name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-group__label" for="pub-address">Address *</label>
                        <input type="text" id="pub-address" class="form-group__input" required placeholder="Start typing an address...">
                        <div id="address-results" class="search-results"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label" for="pub-lat">Latitude</label>
                            <input type="text" id="pub-lat" class="form-group__input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="pub-lon">Longitude</label>
                            <input type="text" id="pub-lon" class="form-group__input" readonly>
                        </div>
                    </div>
                    
                    <h3>Add Initial Beer</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label" for="beer-category">Beer Category *</label>
                            <select id="beer-category" class="form-group__input" required>
                                <option value="house">House/Cheapest</option>
                                <option value="local">Victorian/Australian Beers</option>
                                <option value="guinness">Guinness</option>
                                <option value="pale-ale">Pale Ales</option>
                                <option value="ipa">IPAs</option>
                                <option value="lager">Lagers</option>
                                <option value="dark">Stouts & Porters</option>
                                <option value="specialty">Wheat/Sour/Cider</option>
                                <option value="international">Internationals</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="beer-size">Size *</label>
                            <select id="beer-size" class="form-group__input" required>
                                <option value="pint">Pint (568ml)</option>
                                <option value="schooner">Schooner (425ml)</option>
                                <option value="pot">Pot (285ml)</option>
                                <option value="bottle">Bottle</option>
                                <option value="can">Can</option>
                                <option value="jug">Jug</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-group__label" for="beer-price">Price (AUD) *</label>
                        <input type="number" id="beer-price" class="form-group__input" min="0" step="0.01" required placeholder="0.00">
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--cancel" id="cancel-add-pub">Cancel</button>
                <button class="btn btn--submit" id="submit-pub">Add Pub</button>
            </div>
        </div>
    </div>

    <!-- Submit Price Modal -->
    <div id="submit-price-modal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Submit New Price</h2>
                <button class="modal__close" id="close-submit-price">&times;</button>
            </div>
            <div class="modal__body">
                <div id="submit-price-error" class="error"></div>
                <form id="submit-price-form">
                    <div class="form-group">
                        <label class="form-group__label" for="price-category">Beer Category *</label>
                        <select id="price-category" class="form-group__input" required>
                            <option value="">-- Select Category --</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-group__label" for="price-size">Size *</label>
                            <select id="price-size" class="form-group__input" required>
                                <option value="pint">Pint</option>
                                <option value="schooner">Schooner</option>
                                <option value="pot">Pot</option>
                                <option value="bottle">Bottle</option>
                                <option value="can">Can</option>
                                <option value="jug">Jug</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-group__label" for="price-amount">Price (AUD) *</label>
                            <input type="number" id="price-amount" class="form-group__input" min="0" step="0.01" required placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--cancel" id="cancel-submit-price">Cancel</button>
                <button class="btn btn--submit" id="submit-price">Submit Price</button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <p>BeerSpy alpha v0.1.0 &copy; 2025</p>
    </footer>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            SUPABASE_URL: "https://bvuuhxlsilmroyidaovp.supabase.co",
            SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dXVoeGxzaWxtcm95aWRhb3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MTYzMzgsImV4cCI6MjA1ODk5MjMzOH0.eCueNnzM6ezrpsRqaILPefnFTuRRvhr0g_cWIguqYzc",
            MELBOURNE_COORDS: [-37.8136, 144.9631],
            DEFAULT_ZOOM: 13,
            SEARCH_DEBOUNCE: 300,
            TEST_MODE: false
        };

        const BEER_CATEGORIES = {
            'house': 'House/Cheapest',
            'local': 'Victorian/Australian Beers',
            'guinness': 'Guinness',
            'pale-ale': 'Pale Ales',
            'ipa': 'IPAs',
            'lager': 'Lagers',
            'dark': 'Stouts & Porters',
            'specialty': 'Wheat/Sour/Cider',
            'international': 'Internationals'
        };

        // ========== UTILITY FUNCTIONS ==========
        class Utils {
            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            static showError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.classList.add('error--show');
                }
            }

            static hideError(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.remove('error--show');
                }
            }

            static formatPrice(price) {
                return `$${parseFloat(price).toFixed(2)}`;
            }

            static formatDate(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                return date.toLocaleString(undefined, { 
                    hour12: false, 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
            }

            static getAgeClass(dateString) {
                if (!dateString) return 'old';
                const now = new Date();
                const date = new Date(dateString);
                const ageInDays = (now - date) / (1000 * 60 * 60 * 24);
                
                if (ageInDays <= 7) return 'recent';
                if (ageInDays <= 30) return 'average';
                return 'old';
            }
        }

        // ========== LOCATION SERVICE ==========
        class LocationService {
            static async getUserLocation() {
                // Try GPS first
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                timeout: 5000,
                                enableHighAccuracy: true
                            });
                        });
                        
                        return {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            source: 'gps'
                        };
                    } catch (gpsError) {
                        console.log("GPS failed, trying IP location:", gpsError.message);
                    }
                }

                // Fallback to IP location
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    if (data.latitude && data.longitude) {
                        const lat = parseFloat(data.latitude);
                        const lon = parseFloat(data.longitude);
                        
                        // Check if in Victoria bounds
                        if (lat >= -39.2 && lat <= -34.0 && lon >= 140.9 && lon <= 150.0) {
                            return {
                                lat: lat,
                                lon: lon,
                                source: 'ip',
                                city: data.city,
                                region: data.region
                            };
                        }
                    }
                } catch (ipError) {
                    console.log("IP location failed:", ipError.message);
                }

                throw new Error("No location services available");
            }

            static async geocodeAddress(address) {
                await new Promise(resolve => setTimeout(resolve, 100));
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                    address + ", Melbourne, Australia"
                )}&limit=5&addressdetails=1`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return data || [];
                } catch (error) {
                    console.error("Geocoding error:", error);
                    return [];
                }
            }
        }

        // ========== DATABASE SERVICE ==========
        class DatabaseService {
            constructor() {
                if (!CONFIG.TEST_MODE) {
                    this.client = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                }
            }

            async fetchBeerPrices() {
                if (CONFIG.TEST_MODE) {
                    return this.getTestData();
                }

                try {
                    const { data, error } = await this.client.from("beer_prices").select("*");
                    
                    if (error) {
                        console.error("Supabase error:", error.message);
                        return [];
                    }
                    
                    return data || [];
                } catch (err) {
                    console.error("Database fetch error:", err);
                    return [];
                }
            }

            async savePub(pub) {
                if (CONFIG.TEST_MODE) {
                    console.log("Test mode: would save pub", pub);
                    return;
                }

                try {
                    // Delete existing records
                    const { error: deleteError } = await this.client
                        .from("beer_prices")
                        .delete()
                        .eq("pub_name", pub.name)
                        .eq("lat", pub.lat)
                        .eq("lon", pub.lon);

                    if (deleteError) throw deleteError;

                    // Insert new records
                    const newRecords = pub.beers.map((beer) => ({
                        pub_name: pub.name,
                        beer_name: beer.name,
                        size: beer.size,
                        price: beer.price,
                        lat: pub.lat,
                        lon: pub.lon,
                        location: pub.address,
                        last_updated: new Date().toISOString()
                    }));

                    const { error: insertError } = await this.client
                        .from("beer_prices")
                        .insert(newRecords);

                    if (insertError) throw insertError;

                } catch (err) {
                    console.error("Database save error:", err);
                    throw err;
                }
            }

            getTestData() {
                return [
                    {
                        pub_name: "The Lagerhaus",
                        beer_name: "house",
                        size: "pint",
                        price: 7.5,
                        lat: -37.8140,
                        lon: 144.9643,
                        location: "250 Collins St, Melbourne VIC 3000",
                        last_updated: new Date().toISOString()
                    },
                    {
                        pub_name: "Hoppy Hop",
                        beer_name: "ipa",
                        size: "schooner",
                        price: 8.5,
                        lat: -37.8240,
                        lon: 144.9843,
                        location: "45 Bourke St, Melbourne VIC 3000",
                        last_updated: new Date().toISOString()
                    }
                ];
            }
        }

        // ========== DATA MANAGER ==========
        class DataManager {
            constructor() {
                this.pubs = [];
                this.currentSize = 'pint';
                this.dbService = new DatabaseService();
            }

            async loadData() {
                const rawData = await this.dbService.fetchBeerPrices();
                this.pubs = this.processRawData(rawData);
                return this.pubs;
            }

            processRawData(beerPrices) {
                const pubsMap = new Map();

                beerPrices.forEach((item) => {
                    const pubKey = `${item.pub_name}-${item.lat}-${item.lon}`;

                    if (!pubsMap.has(pubKey)) {
                        pubsMap.set(pubKey, {
                            id: pubsMap.size + 1,
                            name: item.pub_name,
                            address: item.location || "",
                            lat: item.lat,
                            lon: item.lon,
                            beers: [],
                        });
                    }

                    const pub = pubsMap.get(pubKey);
                    pub.beers.push({
                        name: item.beer_name,
                        size: item.size,
                        price: item.price,
                        last_updated: item.last_updated
                    });
                });

                return Array.from(pubsMap.values());
            }

            async savePub(pubData) {
                await this.dbService.savePub(pubData);
                await this.loadData(); // Reload data
            }

            getPubsForSize(size = this.currentSize) {
                return this.pubs.map(pub => ({
                    ...pub,
                    beers: pub.beers.filter(beer => beer.size === size)
                })).filter(pub => pub.beers.length > 0);
            }

            getStatistics() {
                const totalPubs = this.pubs.length;
                
                const uniqueBeerNames = new Set();
                this.pubs.forEach(pub => {
                    pub.beers.forEach(beer => {
                        uniqueBeerNames.add(beer.name);
                    });
                });
                
                const prices = [];
                this.pubs.forEach(pub => {
                    const beersForSize = pub.beers.filter(beer => beer.size === this.currentSize);
                    beersForSize.forEach(beer => prices.push(beer.price));
                });

                const avgPrice = prices.length > 0 
                    ? (prices.reduce((total, price) => total + price, 0) / prices.length).toFixed(2)
                    : "N/A";

                return {
                    totalPubs,
                    totalBeers: uniqueBeerNames.size,
                    avgPrice: avgPrice === "N/A" ? avgPrice : `$${avgPrice}`
                };
            }

            setCurrentSize(size) {
                this.currentSize = size;
            }
        }

        // ========== MAP MANAGER ==========
        class MapManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.map = null;
                this.markers = [];
                this.userLocation = null;
            }

            async initialize() {
                // Try to get user location
                try {
                    this.userLocation = await LocationService.getUserLocation();
                    console.log("Using user location:", this.userLocation);
                } catch (error) {
                    console.log("Using default Melbourne location:", error.message);
                }

                // Create map
                const coords = this.userLocation 
                    ? [this.userLocation.lat, this.userLocation.lon]
                    : CONFIG.MELBOURNE_COORDS;
                
                const zoom = this.userLocation && this.userLocation.source === 'gps' ? 14 : CONFIG.DEFAULT_ZOOM;

                this.map = L.map("map").setView(coords, zoom);

                // Add tile layer
                L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors",
                }).addTo(this.map);

                // Add user location marker if GPS
                if (this.userLocation && this.userLocation.source === 'gps') {
                    L.marker([this.userLocation.lat, this.userLocation.lon], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: '<div class="user-location-icon">📍</div>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(this.map).bindPopup("Your location");
                }

                return this.map;
            }

            renderPubs() {
                // Clear existing markers
                this.markers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                this.markers = [];

                const pubsForSize = this.dataManager.getPubsForSize();

                pubsForSize.forEach(pub => {
                    if (pub.beers.length === 0) return;

                    // Get cheapest beer for this size
                    const minPrice = Math.min(...pub.beers.map(beer => beer.price));
                    const cheapestBeer = pub.beers.find(beer => beer.price === minPrice);
                    
                    const ageClass = Utils.getAgeClass(cheapestBeer.last_updated);

                    const marker = L.marker([pub.lat, pub.lon], {
                        icon: this.createPriceIcon(minPrice, ageClass),
                    }).addTo(this.map);

                    marker.pubData = pub;
                    marker.on("click", () => this.onMarkerClick(pub));
                    this.markers.push(marker);
                });
            }

            createPriceIcon(price, ageClass) {
                return L.divIcon({
                    className: "custom-marker",
                    html: `<div class="price-bubble price-bubble--${ageClass}">${Utils.formatPrice(price)}</div>`,
                    iconSize: [60, 40],
                    iconAnchor: [30, 40],
                });
            }

            onMarkerClick(pub) {
                this.map.closePopup();

                setTimeout(() => {
                    const popup = L.popup()
                        .setLatLng([pub.lat, pub.lon])
                        .setContent(this.createPopupContent(pub))
                        .openOn(this.map);

                    // Add click handler for submit price button
                    setTimeout(() => {
                        const submitBtn = popup.getElement().querySelector('.popup-btn');
                        if (submitBtn) {
                            submitBtn.onclick = () => {
                                app.modalManager.openSubmitPriceModal(pub);
                            };
                        }
                    }, 100);
                }, 50);
            }

            createPopupContent(pub) {
                const beersForCurrentSize = pub.beers.filter(beer => beer.size === this.dataManager.currentSize);
                
                let content = `
                    <div class="pub-popup">
                        <h3 class="pub-popup__title">${pub.name}</h3>
                        <div class="pub-popup__address">${pub.address}</div>
                        <table class="beer-table">
                            <tr>
                                <th>Category</th>
                                <th>Size</th>
                                <th>Price</th>
                            </tr>
                `;

                beersForCurrentSize.forEach(beer => {
                    content += `
                        <tr>
                            <td>${BEER_CATEGORIES[beer.name] || beer.name}</td>
                            <td>${beer.size}</td>
                            <td class="beer-price">${Utils.formatPrice(beer.price)}</td>
                        </tr>
                    `;
                });

                const mostRecentUpdate = beersForCurrentSize.reduce((latest, beer) => {
                    const beerDate = new Date(beer.last_updated);
                    return !latest || beerDate > latest ? beerDate : latest;
                }, null);

                content += `
                        </table>
                        <div class="last-updated">Updated: ${Utils.formatDate(mostRecentUpdate)}</div>
                        <div class="popup-actions">
                            <button class="popup-btn">Submit New Price</button>
                        </div>
                    </div>
                `;

                return content;
            }

            focusOnLocation(lat, lon, zoom = 16) {
                this.map.setView([lat, lon], zoom);
            }
        }

        // ========== SEARCH MANAGER ==========
        class SearchManager {
            constructor(dataManager, mapManager) {
                this.dataManager = dataManager;
                this.mapManager = mapManager;
                this.searchInput = document.getElementById('search-input');
                this.searchResults = document.getElementById('search-results');
                this.setupEventListeners();
            }

            setupEventListeners() {
                const debouncedSearch = Utils.debounce((query) => this.performSearch(query), CONFIG.SEARCH_DEBOUNCE);
                
                this.searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query.length < 2) {
                        this.hideResults();
                        return;
                    }
                    debouncedSearch(query);
                });

                // Hide results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.searchInput.contains(e.target) && !this.searchResults.contains(e.target)) {
                        this.hideResults();
                    }
                });
            }

            async performSearch(query) {
                try {
                    // Search existing pubs
                    const existingResults = this.dataManager.pubs.filter(
                        (pub) =>
                            pub.name.toLowerCase().includes(query.toLowerCase()) ||
                            pub.address.toLowerCase().includes(query.toLowerCase())
                    );

                    // Search for new places
                    let geocodeResults = [];
                    if (query.length >= 3) {
                        const places = await LocationService.geocodeAddress(query);
                        geocodeResults = places.filter(place => {
                            const lat = parseFloat(place.lat);
                            const lon = parseFloat(place.lon);
                            
                            return !this.dataManager.pubs.some(pub => 
                                Math.abs(pub.lat - lat) < 0.001 && 
                                Math.abs(pub.lon - lon) < 0.001
                            );
                        });
                    }

                    this.displayResults(existingResults, geocodeResults);
                } catch (error) {
                    console.error("Search error:", error);
                    this.showErrorResult();
                }
            }

            displayResults(existingResults, geocodeResults) {
                let html = '';

                // Existing pubs
                if (existingResults.length > 0) {
                    html += existingResults.slice(0, 3).map(pub => `
                        <div class="search-item search-item--existing" data-type="existing" data-lat="${pub.lat}" data-lon="${pub.lon}">
                            <div class="place-name">${pub.name}</div>
                            <div class="place-address">${pub.address}</div>
                            <div class="place-type">Existing pub • ${pub.beers.length} beers listed</div>
                        </div>
                    `).join('');
                }

                // New locations
                if (geocodeResults.length > 0) {
                    html += geocodeResults.slice(0, 3).map(place => {
                        const pubName = this.extractPubName(place);
                        return `
                            <div class="search-item search-item--new" 
                                 data-type="new" 
                                 data-lat="${place.lat}" 
                                 data-lon="${place.lon}"
                                 data-name="${pubName}"
                                 data-address="${place.display_name}">
                                <div class="place-name">${pubName}</div>
                                <div class="place-address">${place.display_name}</div>
                                <div class="place-type">New location • Click to add as pub</div>
                            </div>
                        `;
                    }).join('');
                }

                if (html) {
                    this.searchResults.innerHTML = html;
                    this.showResults();
                    this.attachResultClickHandlers();
                } else {
                    this.searchResults.innerHTML = '<div class="search-item">No results found</div>';
                    this.showResults();
                }
            }

            attachResultClickHandlers() {
                this.searchResults.querySelectorAll('.search-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const lat = parseFloat(item.dataset.lat);
                        const lon = parseFloat(item.dataset.lon);
                        const type = item.dataset.type;

                        if (type === 'existing') {
                            this.mapManager.focusOnLocation(lat, lon);
                            this.hideResults();
                            this.searchInput.value = '';
                            
                            // Find and click the marker
                            const marker = this.mapManager.markers.find(m => 
                                Math.abs(m.getLatLng().lat - lat) < 0.0001 && 
                                Math.abs(m.getLatLng().lng - lon) < 0.0001
                            );
                            if (marker) {
                                setTimeout(() => marker.fire('click'), 200);
                            }
                        } else {
                            // Open add pub modal with pre-filled data
                            app.modalManager.openAddPubModal({
                                name: item.dataset.name,
                                address: item.dataset.address,
                                lat: lat,
                                lon: lon
                            });
                            this.hideResults();
                            this.searchInput.value = '';
                        }
                    });
                });
            }

            extractPubName(placeData) {
                if (placeData.name) return placeData.name;
                if (placeData.display_name) {
                    return placeData.display_name.split(',')[0].trim();
                }
                return 'Unknown Location';
            }

            showResults() {
                this.searchResults.classList.add('search-results--show');
            }

            hideResults() {
                this.searchResults.classList.remove('search-results--show');
            }

            showErrorResult() {
                this.searchResults.innerHTML = '<div class="search-item">Search error occurred</div>';
                this.showResults();
            }
        }

        // ========== MODAL MANAGER ==========
        class ModalManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Add Pub Modal
                document.getElementById('add-pub-btn').addEventListener('click', () => {
                    this.openAddPubModal();
                });

                document.getElementById('close-add-pub').addEventListener('click', () => {
                    this.closeAddPubModal();
                });

                document.getElementById('cancel-add-pub').addEventListener('click', () => {
                    this.closeAddPubModal();
                });

                document.getElementById('submit-pub').addEventListener('click', () => {
                    this.handleAddPubSubmit();
                });

                // Submit Price Modal
                document.getElementById('close-submit-price').addEventListener('click', () => {
                    this.closeSubmitPriceModal();
                });

                document.getElementById('cancel-submit-price').addEventListener('click', () => {
                    this.closeSubmitPriceModal();
                });

                document.getElementById('submit-price').addEventListener('click', () => {
                    this.handleSubmitPriceSubmit();
                });
            }

            openAddPubModal(prefillData = null) {
                const modal = document.getElementById('add-pub-modal');
                
                // Reset form
                document.getElementById('add-pub-form').reset();
                Utils.hideError('add-pub-error');

                // Prefill if data provided
                if (prefillData) {
                    document.getElementById('pub-name').value = prefillData.name || '';
                    document.getElementById('pub-address').value = prefillData.address || '';
                    document.getElementById('pub-lat').value = prefillData.lat || '';
                    document.getElementById('pub-lon').value = prefillData.lon || '';
                    
                    if (prefillData.lat && prefillData.lon) {
                        app.mapManager.focusOnLocation(prefillData.lat, prefillData.lon);
                    }
                }

                modal.classList.add('modal--show');
            }

            closeAddPubModal() {
                const modal = document.getElementById('add-pub-modal');
                modal.classList.remove('modal--show');
                Utils.hideError('add-pub-error');
            }

            async handleAddPubSubmit() {
                const name = document.getElementById('pub-name').value.trim();
                const address = document.getElementById('pub-address').value.trim();
                const lat = parseFloat(document.getElementById('pub-lat').value);
                const lon = parseFloat(document.getElementById('pub-lon').value);
                const beerCategory = document.getElementById('beer-category').value;
                const beerSize = document.getElementById('beer-size').value;
                const beerPrice = parseFloat(document.getElementById('beer-price').value);

                // Validation
                if (!name || !address || !beerCategory || !beerSize || isNaN(lat) || isNaN(lon) || isNaN(beerPrice)) {
                    Utils.showError('add-pub-error', 'Please fill in all required fields');
                    return;
                }

                const newPub = {
                    id: this.dataManager.pubs.length + 1,
                    name,
                    address,
                    lat,
                    lon,
                    beers: [{
                        name: beerCategory,
                        size: beerSize,
                        price: beerPrice
                    }]
                };

                try {
                    await this.dataManager.savePub(newPub);
                    app.updateDisplay();
                    this.closeAddPubModal();
                } catch (error) {
                    Utils.showError('add-pub-error', `Failed to save pub: ${error.message}`);
                }
            }

            openSubmitPriceModal(pub) {
                this.currentPub = pub;
                const modal = document.getElementById('submit-price-modal');
                
                // Reset form
                document.getElementById('submit-price-form').reset();
                Utils.hideError('submit-price-error');

                // Populate beer categories from this pub
                const categorySelect = document.getElementById('price-category');
                categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
                
                const uniqueCategories = [...new Set(pub.beers.map(beer => beer.name))];
                uniqueCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = BEER_CATEGORIES[category] || category;
                    categorySelect.appendChild(option);
                });

                modal.classList.add('modal--show');
            }

            closeSubmitPriceModal() {
                const modal = document.getElementById('submit-price-modal');
                modal.classList.remove('modal--show');
                Utils.hideError('submit-price-error');
                this.currentPub = null;
            }

            async handleSubmitPriceSubmit() {
                if (!this.currentPub) {
                    Utils.showError('submit-price-error', 'No pub selected');
                    return;
                }

                const category = document.getElementById('price-category').value;
                const size = document.getElementById('price-size').value;
                const price = parseFloat(document.getElementById('price-amount').value);

                if (!category || !size || isNaN(price)) {
                    Utils.showError('submit-price-error', 'Please fill in all fields');
                    return;
                }

                // Add new beer to pub
                this.currentPub.beers.push({
                    name: category,
                    size: size,
                    price: price,
                    last_updated: new Date().toISOString()
                });

                try {
                    await this.dataManager.savePub(this.currentPub);
                    app.updateDisplay();
                    this.closeSubmitPriceModal();
                } catch (error) {
                    Utils.showError('submit-price-error', `Failed to submit price: ${error.message}`);
                }
            }
        }

        // ========== MAIN APPLICATION ==========
        class BeerSpyApp {
            constructor() {
                this.dataManager = new DataManager();
                this.mapManager = new MapManager(this.dataManager);
                this.modalManager = new ModalManager(this.dataManager);
            }

            async initialize() {
                try {
                    console.log("Initializing BeerSpy...");
                    
                    // Initialize map
                    await this.mapManager.initialize();
                    
                    // Initialize search
                    this.searchManager = new SearchManager(this.dataManager, this.mapManager);
                    
                    // Setup size filter
                    this.setupSizeFilter();
                    
                    // Load data and render
                    await this.dataManager.loadData();
                    this.updateDisplay();
                    
                    console.log("BeerSpy initialized successfully");
                } catch (error) {
                    console.error("Failed to initialize BeerSpy:", error);
                    Utils.showError('add-pub-error', `Failed to initialize: ${error.message}`);
                }
            }

            setupSizeFilter() {
                const sizeFilter = document.getElementById('size-filter');
                sizeFilter.addEventListener('click', (e) => {
                    if (e.target.classList.contains('size-btn')) {
                        // Update active button
                        sizeFilter.querySelectorAll('.size-btn').forEach(btn => {
                            btn.classList.remove('size-btn--active');
                        });
                        e.target.classList.add('size-btn--active');
                        
                        // Update current size and re-render
                        this.dataManager.setCurrentSize(e.target.dataset.size);
                        this.updateDisplay();
                    }
                });
            }

            updateDisplay() {
                this.mapManager.renderPubs();
                this.updateStatistics();
            }

            updateStatistics() {
                const stats = this.dataManager.getStatistics();
                
                document.getElementById('pubs-count').textContent = stats.totalPubs;
                document.getElementById('beers-count').textContent = stats.totalBeers;
                document.getElementById('avg-price').textContent = stats.avgPrice;
            }
        }

        // ========== APPLICATION STARTUP ==========
        let app;

        document.addEventListener('DOMContentLoaded', async () => {
            app = new BeerSpyApp();
            await app.initialize();
        });
    </script>
</body>
</html>