<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeerSpy Melbourne - Live Beer Prices Map</title>
    
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts for typography -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Add your existing CSS styles here */
        /* ... */
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="container">
            <div class="logo">
                <div class="beer-icon">üç∫</div>
                <div>
                    <h1>BeerSpy</h1>
                    <p>yum yum dot com</p>
                </div>
            </div>
        </div>
    </header>
    
    <div id="main-container">
        <!-- Map Container -->
        <div id="map-container">
            <div id="map"></div>
            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="pub-search" placeholder="Search pubs by name or address...">
                    <button class="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
        
        <!-- Map Controls Panel -->
        <div id="map-controls">
            <div class="control-section">
                <h3>Add a New Pub</h3>
                <button id="add-pub-btn">
                    <i class="fas fa-plus"></i> Enter Pub Details
                </button>
            </div>
            <div class="control-section">
                <h3>Submit New Price</h3>
                <button class="add-beer-btn">
                    <i class="fas fa-plus"></i> Submit New Price
                </button>
            </div>
            <!-- Add other controls here -->
        </div>
    </div>
    
    <!-- Add Pub Modal -->
    <div class="modal" id="add-pub-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Pub</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Pub form fields go here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel">Cancel</button>
                <button class="modal-btn btn-submit">Add Pub</button>
            </div>
        </div>
    </div>
    
    <!-- Submit New Price Modal -->
    <div class="modal" id="add-beer-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit New Price</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Existing Beers</h3>
                <div id="existing-beers-list"></div>
                
                <h3>Add New Beer</h3>
                <div class="form-group">
                    <label for="new-beer-name">New Beer Name *</label>
                    <input type="text" id="new-beer-name" placeholder="Enter beer name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-beer-size">Size</label>
                        <select id="new-beer-size">
                            <option value="pint">Pint</option>
                            <option value="schooner">Schooner</option>
                            <option value="can">Can</option>
                            <option value="jug">Jug</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-beer-price">Price (AUD) *</label>
                        <input type="number" id="new-beer-price" min="0" step="0.01" placeholder="0.00">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel">Cancel</button>
                <button class="modal-btn btn-submit">Submit Price</button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <p>BeerSpy Melbourne &copy; 2023 - Find the best beer prices in town</p>
    </footer>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_KEY';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Initialize the pubs array
        let pubs = []; // This will hold your pub data

        document.addEventListener("DOMContentLoaded", async function() {
            console.log("BeerSpy app initialized");

            // Fetch pubs from Supabase
            const { data, error } = await supabase
                .from('pubs')
                .select('*');

            if (error) {
                console.error('Error fetching pubs:', error);
            } else {
                pubs = data; // Assign fetched data to pubs
                renderPubs(); // Render pubs on the map
            }

            // Initialize the map
            const map = L.map('map').setView([-37.8136, 144.9631], 13);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Show modal for submitting new prices
            document.querySelector('.add-beer-btn').addEventListener('click', function() {
                document.getElementById('add-beer-modal').style.display = 'flex';
                populateExistingBeers(); // Populate the beer list
            });

            // Populate existing beers
            function populateExistingBeers() {
                const existingBeersList = document.getElementById('existing-beers-list');
                existingBeersList.innerHTML = ''; // Clear previous entries

                pubs.forEach(pub => {
                    pub.beers.forEach(beer => {
                        const beerElement = document.createElement('div');
                        beerElement.innerHTML = `
                            <div>
                                <strong>${beer.name}</strong> (${beer.size}): 
                                <input type="number" placeholder="Price" data-pub="${pub.id}" data-beer="${beer.name}" min="0" step="0.01">
                            </div>
                        `;
                        existingBeersList.appendChild(beerElement);
                    });
                });
            }

            // Submit new beer prices
            document.querySelector('.btn-submit').addEventListener('click', async function() {
                const newBeerName = document.getElementById('new-beer-name').value.trim();
                const newBeerSize = document.getElementById('new-beer-size').value;
                const newBeerPrice = parseFloat(document.getElementById('new-beer-price').value);

                // Add new beer if provided
                if (newBeerName && !isNaN(newBeerPrice)) {
                    const pubId = /* logic to get the relevant pub id, e.g., from a selected pub */;
                    const pub = pubs.find(p => p.id === pubId);
                    if (pub) {
                        pub.beers.push({ name: newBeerName, size: newBeerSize, price: newBeerPrice });
                        await supabase
                            .from('beers')
                            .insert([{ pub_id: pubId, name: newBeerName, size: newBeerSize, price: newBeerPrice }]);
                        renderPubs(); // Refresh the map
                    }
                }

                // Update prices for existing beers
                const priceInputs = document.querySelectorAll('#existing-beers-list input[type="number"]');
                priceInputs.forEach(async input => {
                    const beerName = input.dataset.beer;
                    const pubId = parseInt(input.dataset.pub);
                    const updatedPrice = parseFloat(input.value);
                    
                    if (!isNaN(updatedPrice)) {
                        const pub = pubs.find(p => p.id === pubId);
                        const beer = pub.beers.find(b => b.name === beerName);
                        if (beer) {
                            beer.price = updatedPrice; // Update the price
                            await supabase
                                .from('beers')
                                .update({ price: updatedPrice })
                                .match({ pub_id: pubId, name: beerName });
                        }
                    }
                });

                // Close modal and reset form
                document.getElementById('add-beer-modal').style.display = 'none';
                resetForm();
            });

            // Other existing functions and event listeners...
        });
    </script>
</body>
</html>